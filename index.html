<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dompet & Target Bersama</title>

    <!-- Kode Verifikasi Google Anda sudah dimasukkan di sini -->
    <meta name="google-site-verification" content="9b5idOC6Ce2_GFZmJStbYbVjZ1qelnaRPCkxhu9qpxM" />

    <!-- Icon untuk Layar Utama (iOS) -->
    <!-- Menggunakan logo hitam yang diunggah oleh pengguna -->
    <link rel="apple-touch-icon" href="uploaded:original-b142c02ab6f9b991e3b36855fa55d403.webp-233117a0-40ae-4400-af34-da550a46276e">
    <!-- Manifest untuk Progressive Web App (PWA) untuk Android dan lainnya -->
    <!-- Pastikan Anda membuat file manifest.json di root direktori Anda -->
    <link rel="manifest" href="/manifest.json">

    <!-- Memuat Library -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Library untuk ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Custom styles for a more appealing look */
        body {
            font-family: 'Inter', sans-serif;
        }
        .shadow-custom-blue {
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1), 0 4px 6px -2px rgba(59, 130, 246, 0.05);
        }
        .shadow-custom-green {
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.1), 0 4px 6px -2px rgba(16, 185, 129, 0.05);
        }
        .shadow-custom-red {
            box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.1), 0 4px 6px -2px rgba(239, 68, 68, 0.05);
        }
        .shadow-custom-purple {
            box-shadow: 0 10px 15px -3px rgba(139, 92, 246, 0.1), 0 4px 6px -2px rgba(139, 92, 246, 0.05);
        }
        .shadow-custom-gray {
            box-shadow: 0 10px 15px -3px rgba(107, 114, 128, 0.1), 0 4px 6px -2px rgba(107, 114, 128, 0.05);
        }
        /* Style for active tab button */
        .tab-active {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .tab-active span {
            font-weight: 600;
        }
        /* Custom shadow for diary button */
        .shadow-custom-yellow {
            box-shadow: 0 10px 15px -3px rgba(252, 211, 77, 0.1), 0 4px 6px -2px rgba(252, 211, 77, 0.05);
        }
        /* Custom shadow for financial cards */
        .shadow-custom-card-blue {
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1), 0 2px 4px -1px rgba(59, 130, 246, 0.06);
        }
        .shadow-custom-card-green {
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.1), 0 2px 4px -1px rgba(16, 185, 129, 0.06);
        }
        .shadow-custom-card-purple {
            box-shadow: 0 4px 6px -1px rgba(139, 92, 246, 0.1), 0 2px 4px -1px rgba(139, 92, 246, 0.06);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- Memuat Firebase SDK ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, where, serverTimestamp, updateDoc, arrayUnion, arrayRemove, increment, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Konfigurasi Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyB91qA6AGjNBAEyIQSlHvN482esZKlP_Ok",
            authDomain: "dompet-pasangan-kita.firebaseapp.com",
            projectId: "dompet-pasangan-kita",
            storageBucket: "dompet-pasangan-kita.appspot.com",
            messagingSenderId: "54318864599",
            appId: "1:54318864599:web:3fc852b439a62577563892"
        };

        // --- Inisialisasi Firebase ---
        let app, db, authInstance;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            authInstance = getAuth(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        // --- Komponen Ikon ---
        const PlusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>;
        const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const CopyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>;
        const TargetIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path strokeLinecap="round" strokeLinejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const MoneyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>;
        const PiggyBankIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" /></svg>;
        const HomeIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>;
        const CameraIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clipRule="evenodd" /></svg>;
        const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M16 7a4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>;
        const LockClosedIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" /><path strokeLinecap="round" strokeLinejoin="round" d="M11 11V9a3 3 0 00-6 0v2m8 0V9a3 3 0 016 0v2" /></svg>;
        // Icon baru untuk menu bawah
        const ChartBarIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2v-6a2 2 0 012-2h2a2 2 0 012 2v6a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2v10a2 2 0 01-2 2h-2a2 2 0 01-2-2v-7a2 2 0 00-2-2H9a2 2 0 00-2 2v7a2 2 0 002 2z" /></svg>;
        const WalletIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>;
        const GiftIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const CalendarIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>;
        const ShareIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 100-2.684 3 3 0 000 2.684z" /></svg>;
        const BookOpenIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.206 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.794 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.794 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.206 18 16.5 18s-3.332.477-4.5 1.253" /></svg>;
        const MapPinIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243m0 0A8 8 0 1116.657 7.343a8 8 0 01-9.9 9.9z" /></svg>;
        const BellIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>;
        // Ikon baru untuk Kebiasaan: Check Square
        const CheckSquareIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        // Ikon baru untuk Menu: Hamburger
        const MenuIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>;
        const CloseIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;
        // Icon untuk Budget
        const ChartPieIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path strokeLinecap="round" strokeLinejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>;
        // Icon untuk Shopping List
        const ShoppingCartIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>;


        // Helper function to recursively remove undefined values from an object
        // Firestore does not allow undefined values.
        const removeUndefined = (obj) => {
            if (obj === null || typeof obj !== 'object') {
                return obj;
            }

            if (Array.isArray(obj)) {
                return obj.map(removeUndefined);
            }

            const newObj = {};
            for (const key in obj) {
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    const value = obj[key];
                    if (value !== undefined) {
                        newObj[key] = removeUndefined(value);
                    }
                }
            }
            return newObj;
        };


        const formatCurrency = (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value);
        const getMonthYear = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        // Function to get month name in Indonesian
        const getMonthName = (monthIndex) => {
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni",
                                "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            return monthNames[monthIndex];
        };

        // Custom Modal/Message Box component
        const MessageBox = ({ message, onClose }) => {
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                        <p className="text-gray-800 text-lg mb-4">{message}</p>
                        <button
                            onClick={onClose}
                            className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200"
                        >
                            OK
                        </button>
                    </div>
                </div>
            );
        };

        // --- Komponen AuthScreen (Baru) ---
        const AuthScreen = ({ onLogin, onRegister, authError }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [isRegisterMode, setIsRegisterMode] = React.useState(false);
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            React.useEffect(() => {
                if (authError) {
                    setError(authError.message || "Terjadi kesalahan otentikasi.");
                } else {
                    setError('');
                }
            }, [authError]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    if (isRegisterMode) {
                        await onRegister(email, password);
                    } else {
                        await onLogin(email, password);
                    }
                } catch (err) {
                    setError(err.message || "Terjadi kesalahan. Silakan coba lagi.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
                    <div className="w-full max-w-md bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-8 text-center">
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">Dompet & Target Bersama</h1>
                        <p className="text-gray-600 mb-8">{isRegisterMode ? 'Daftar Akun Baru' : 'Masuk ke Akun Anda'}</p>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="relative">
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    placeholder="Email"
                                    className="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                />
                                <UserIcon className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                            </div>
                            <div className="relative">
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="Kata Sandi"
                                    className="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    required
                                />
                                <LockClosedIcon className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                            </div>

                            {error && <p className="text-red-600 text-sm">{error}</p>}

                            <button
                                type="submit"
                                className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-200 disabled:bg-blue-300"
                                disabled={loading}
                            >
                                {loading ? 'Memproses...' : (isRegisterMode ? 'Daftar' : 'Masuk')}
                            </button>
                        </form>

                        <button
                            onClick={() => setIsRegisterMode(!isRegisterMode)}
                            className="mt-6 text-blue-600 hover:underline text-sm"
                            disabled={loading}
                        >
                            {isRegisterMode ? 'Sudah punya akun? Masuk di sini.' : 'Belum punya akun? Daftar di sini.'}
                        </button>
                    </div>
                </div>
            );
        };

        // --- Komponen Dashboard ---
        const Dashboard = ({ user, ledgerId, setActiveTab, ledgerDoc, selectedDate, setFirestoreError }) => {
            const { PieChart, Pie, Cell, Tooltip, ResponsiveContainer, LineChart, Line, XAxis, YAxis, CartesianGrid, Legend } = window.Recharts || {};
            const [transactions, setTransactions] = React.useState([]);
            const [goals, setGoals] = React.useState([]);
            const [budgets, setBudgets] = React.useState([]); // New state for budgets
            const [isLoading, setIsLoading] = React.useState(true);
            const [messageBox, setMessageBox] = React.useState(null); // State for custom message box

            // Function to show custom message box
            const showMessage = (msg) => {
                setMessageBox(msg);
            };

            // Function to close custom message box
            const closeMessageBox = () => {
                setMessageBox(null);
            };

            // Fetch transactions for the entire year for line chart
            React.useEffect(() => {
                if (!user || !ledgerId || !db) {
                    setIsLoading(false);
                    return;
                }
                setIsLoading(true);
                // Fetch all transactions for the current year
                const currentYear = selectedDate.getFullYear();
                const transQuery = query(collection(db, `ledgers/${ledgerId}/transactions`));
                const goalsQuery = query(collection(db, `ledgers/${ledgerId}/savings`));
                const budgetsQuery = query(collection(db, `ledgers/${ledgerId}/budgets`)); // Query for budgets

                const unsubTransactions = onSnapshot(transQuery, (snapshot) => {
                    const allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Filter transactions for the current year in memory
                    const yearTransactions = allTransactions.filter(t => {
                        // Safely access toDate()
                        if (t.createdAt && typeof t.createdAt.toDate === 'function') {
                            const date = t.createdAt.toDate();
                            return date.getFullYear() === currentYear;
                        }
                        return false;
                    });
                    setTransactions(yearTransactions);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching transactions:", error);
                    if (error.code === 'permission-denied') {
                        setFirestoreError("Kesalahan Izin: Gagal memuat transaksi. Pastikan Aturan Keamanan Firestore Anda mengizinkan akses untuk ledger ini. Silakan periksa Firebase Console Anda.");
                    }
                    setIsLoading(false);
                });

                const unsubGoals = onSnapshot(goalsQuery, (snapshot) => {
                    setGoals(snapshot.docs.map(doc => doc.data()));
                }, (error) => {
                    console.error("Error fetching goals:", error);
                    if (error.code === 'permission-denied') {
                        setFirestoreError("Kesalahan Izin: Gagal memuat target tabungan. Pastikan Aturan Keamanan Firestore Anda mengizinkan akses untuk ledger ini. Silakan periksa Firebase Console Anda.");
                    }
                    setIsLoading(false);
                });

                const unsubBudgets = onSnapshot(budgetsQuery, (snapshot) => {
                    setBudgets(snapshot.docs.map(doc => doc.data()));
                }, (error) => {
                    console.error("Error fetching budgets:", error);
                    if (error.code === 'permission-denied') {
                        setFirestoreError("Kesalahan Izin: Gagal memuat anggaran. Pastikan Aturan Keamanan Firestore Anda mengizinkan akses untuk ledger ini. Silakan periksa Firebase Console Anda.");
                    }
                });

                return () => {
                    unsubTransactions();
                    unsubGoals();
                    unsubBudgets();
                };
            }, [user, ledgerId, selectedDate, setFirestoreError]); // Depend on selectedDate to re-fetch for new year if month changes year

            // Calculate current month's financials
            const { totalIncome, totalExpense, balance, myIncome, myExpense, myBalance, partnerIncome, partnerExpense, partnerBalance } = React.useMemo(() => {
                const currentMonthYear = getMonthYear(selectedDate);
                const monthlyTransactions = transactions.filter(t => t.monthYear === currentMonthYear);

                let totalIncome = 0;
                let totalExpense = 0;
                let myIncome = 0;
                let myExpense = 0;
                let partnerIncome = 0;
                let partnerExpense = 0;

                monthlyTransactions.forEach(t => {
                    if (t.type === 'pemasukan') {
                        totalIncome += Number(t.amount);
                        if (t.userId === user.uid) {
                            myIncome += Number(t.amount);
                        } else {
                            partnerIncome += Number(t.amount);
                        }
                    } else if (t.type === 'pengeluaran') {
                        totalExpense += Number(t.amount);
                        if (t.userId === user.uid) {
                            myExpense += Number(t.amount);
                        } else {
                            partnerExpense += Number(t.amount);
                        }
                    }
                });

                return {
                    totalIncome,
                    totalExpense,
                    balance: totalIncome - totalExpense,
                    myIncome,
                    myExpense,
                    myBalance: myIncome - myExpense,
                    partnerIncome,
                    partnerExpense,
                    partnerBalance: partnerIncome - partnerExpense
                };
            }, [transactions, selectedDate, user]);

            const { totalSaved, activeGoals } = React.useMemo(() => {
                const saved = goals.reduce((sum, g) => sum + Number(g.currentAmount), 0);
                return { totalSaved: saved, activeGoals: goals.length };
            }, [goals]);

            // Data for Expense Distribution (Donut Chart) for current month
            const expenseChartData = React.useMemo(() => {
                const currentMonthYear = getMonthYear(selectedDate);
                const monthlyExpenses = transactions.filter(t => t.type === 'pengeluaran' && t.monthYear === currentMonthYear);

                const expensesByUser = monthlyExpenses
                    .reduce((acc, t) => {
                        const name = t.userName || 'Lainnya';
                        if (!acc[name]) acc[name] = 0;
                        acc[name] += Number(t.amount);
                        return acc;
                    }, {});

                return Object.keys(expensesByUser).map(name => ({ name, value: expensesByUser[name] }));
            }, [transactions, selectedDate]);

            // Data for Financial Trend (Line Chart) for the year
            const financialTrendData = React.useMemo(() => {
                const monthlyData = {};
                for (let i = 0; i < 12; i++) {
                    const monthDate = new Date(selectedDate.getFullYear(), i, 1);
                    const monthYearKey = getMonthYear(monthDate);
                    monthlyData[monthYearKey] = {
                        name: getMonthName(i),
                        myPemasukan: 0,
                        myPengeluaran: 0,
                        partnerPemasukan: 0,
                        partnerPengeluaran: 0,
                        saldo: 0 // This will be the cumulative balance for the ledger
                    };
                }

                transactions.forEach(t => {
                    // Safely access toDate()
                    if (t.createdAt && typeof t.createdAt.toDate === 'function') {
                        const date = t.createdAt.toDate();
                        const monthYearKey = getMonthYear(date);
                        if (monthlyData[monthYearKey]) {
                            if (t.userId === user.uid) { // My transaction
                                if (t.type === 'pemasukan') {
                                    monthlyData[monthYearKey].myPemasukan += Number(t.amount);
                                } else if (t.type === 'pengeluaran') {
                                    monthlyData[monthYearKey].myPengeluaran += Number(t.amount);
                                }
                            } else { // Assume it's partner's transaction if not mine
                                if (t.type === 'pemasukan') {
                                    monthlyData[monthYearKey].partnerPemasukan += Number(t.amount);
                                } else if (t.type === 'pengeluaran') {
                                    monthlyData[monthYearKey].partnerPengeluaran += Number(t.amount);
                                }
                            }
                        }
                    }
                });

                // Calculate cumulative balance for the trend
                let cumulativeBalance = 0;
                return Object.values(monthlyData).map(month => {
                    cumulativeBalance += (month.myPemasukan + month.partnerPemasukan) - (month.myPengeluaran + month.partnerPengeluaran);
                    return { ...month, saldo: cumulativeBalance };
                });
            }, [transactions, selectedDate, user]);

            // Data for Daily Financial Trend (Line Chart) for the current month
            const dailyFinancialTrendData = React.useMemo(() => {
                const daysInCurrentMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0).getDate();
                const dailyData = {};

                for (let i = 1; i <= daysInCurrentMonth; i++) {
                    const dateKey = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dailyData[dateKey] = {
                        name: String(i), // Day number
                        pemasukan: 0,
                        pengeluaran: 0,
                    };
                }

                transactions.forEach(t => {
                    if (t.createdAt && typeof t.createdAt.toDate === 'function') {
                        const date = t.createdAt.toDate();
                        const dayOfMonth = date.getDate();
                        const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(dayOfMonth).padStart(2, '0')}`;

                        if (dailyData[dateKey]) {
                            if (t.type === 'pemasukan') {
                                dailyData[dateKey].pemasukan += Number(t.amount);
                            } else if (t.type === 'pengeluaran') {
                                dailyData[dateKey].pengeluaran += Number(t.amount);
                            }
                        }
                    }
                });

                return Object.values(dailyData);
            }, [transactions, selectedDate]);


            const partner = React.useMemo(() => {
                // FIX: Pastikan ledgerDoc dan participants ada sebelum mengakses
                if (!ledgerDoc || !ledgerDoc.participants || !user) return null;
                const partnerUid = Object.keys(ledgerDoc.participants).find(uid => uid !== user.uid);
                if (!partnerUid) return null;
                return { uid: partnerUid, ...ledgerDoc.participants[partnerUid] };
            }, [ledgerDoc, user]);

            const COLORS = ['#3B82F6', '#EF4444', '#F97316', '#8B5CF6', '#10B981', '#6366F1']; // More colors for donut chart

            const handleExportPdf = async () => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'a4'); // 'p' for portrait, 'pt' for points, 'a4' size

                // Capture the main content area
                const content = document.getElementById('dashboard-content-to-export');
                if (!content) {
                    showMessage('Konten untuk diekspor tidak ditemukan!');
                    return;
                }

                showMessage('Mempersiapkan laporan PDF. Ini mungkin memakan waktu sebentar...');

                try {
                    const canvas = await html2canvas(content, {
                        scale: 2, // Increase scale for better quality
                        useCORS: true, // Enable CORS for images if any
                        logging: true,
                        scrollY: -window.scrollY, // Capture elements outside viewport
                        windowWidth: document.documentElement.offsetWidth,
                        windowHeight: document.documentElement.offsetHeight
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 595; // A4 width in points
                    const pageHeight = 842; // A4 height in points
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(`Laporan_Keuangan_${getMonthName(selectedDate.getMonth())}_${selectedDate.getFullYear()}.pdf`);
                    showMessage('Laporan PDF berhasil dibuat!');
                } catch (error) {
                    console.error("Error generating PDF:", error);
                    showMessage('Gagal membuat laporan PDF. Silakan coba lagi.');
                }
            };


            if (isLoading) return <p className="text-center text-gray-500 mt-8">Memuat Dashboard...</p>;

            return (
                <>
                    {messageBox && <MessageBox message={messageBox} onClose={closeMessageBox} />}
                    <div className="space-y-8" id="dashboard-content-to-export"> {/* ID for PDF export */}
                        <div className="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg flex flex-col md:flex-row justify-between items-center border border-gray-100">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-1">Selamat Datang, {user?.name || 'Pengguna'}!</h2>
                                <p className="text-gray-600">Ini ringkasan keuangan Anda untuk bulan {selectedDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}.</p>
                            </div>
                            {partner && (
                                <div className="text-right mt-4 md:mt-0">
                                    <p className="text-sm text-gray-500">Pasangan Anda</p>
                                    <div className="flex items-center justify-end gap-2">
                                        <span className="font-semibold text-gray-700">{partner.name || 'Anonim'}</span>
                                        <img src={partner.photoURL || 'https://placehold.co/40x40/E2E8F0/4A5568?text=?'} alt={partner.name || 'Partner'} className="w-10 h-10 rounded-full object-cover border-2 border-blue-300" />
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Rekap Bulanan & Ringkasan */}
                        <div className="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-100">
                            <h3 className="font-bold text-xl text-gray-800 mb-4">Rekap Keuangan Bulan Ini</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                                <div className="p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-xl shadow-sm border border-green-200">
                                    <p className="text-sm text-green-700 font-medium">Pemasukan</p>
                                    <p className="text-3xl font-bold text-green-800 mt-1">{formatCurrency(totalIncome)}</p>
                                </div>
                                <div className="p-4 bg-gradient-to-br from-red-50 to-red-100 rounded-xl shadow-sm border border-red-200">
                                    <p className="text-sm text-red-700 font-medium">Pengeluaran</p>
                                    <p className="text-3xl font-bold text-red-800 mt-1">{formatCurrency(totalExpense)}</p>
                                </div>
                                <div className="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl shadow-sm border border-blue-200">
                                    <p className="text-sm text-blue-700 font-medium">Saldo Bersih</p>
                                    <p className={`text-3xl font-bold ${balance >= 0 ? 'text-blue-800' : 'text-red-800'} mt-1`}>{formatCurrency(balance)}</p>
                                </div>
                            </div>
                            <button
                                onClick={handleExportPdf}
                                className="w-full mt-6 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:from-blue-600 hover:to-blue-700 transition duration-300 flex items-center justify-center shadow-custom-blue"
                            >
                                <ShareIcon />
                                <span>Ekspor Laporan PDF</span>
                            </button>
                        </div>

                        {/* Ringkasan Keuangan Individu */}
                        <div className="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-100">
                            <h3 className="font-bold text-xl text-gray-800 mb-4">Ringkasan Keuangan Individu Bulan Ini</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Ringkasan Saya */}
                                <div className="p-4 bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-xl shadow-sm border border-indigo-200">
                                    <p className="text-sm text-indigo-700 font-medium">Ringkasan Saya</p>
                                    <p className="text-lg font-bold text-indigo-800 mt-1">Pemasukan: {formatCurrency(myIncome)}</p>
                                    <p className="text-lg font-bold text-indigo-800">Pengeluaran: {formatCurrency(myExpense)}</p>
                                    <p className={`text-xl font-bold ${myBalance >= 0 ? 'text-indigo-800' : 'text-red-800'}`}>Sisa Saldo: {formatCurrency(myBalance)}</p>
                                </div>
                                {/* Ringkasan Pasangan */}
                                <div className="p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl shadow-sm border border-purple-200">
                                    <p className="text-sm text-purple-700 font-medium">Ringkasan {partner?.name || 'Pasangan'}</p>
                                    <p className="text-lg font-bold text-purple-800 mt-1">Pemasukan: {formatCurrency(partnerIncome)}</p>
                                    <p className="text-lg font-bold text-purple-800">Pengeluaran: {formatCurrency(partnerExpense)}</p>
                                    <p className={`text-xl font-bold ${partnerBalance >= 0 ? 'text-purple-800' : 'text-red-800'}`}>Sisa Saldo: {formatCurrency(partnerBalance)}</p>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            {/* Distribusi Pengeluaran (Donut Chart) */}
                            <div className="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-100">
                                <h3 className="font-bold text-xl text-gray-800 mb-4">Distribusi Pengeluaran Bulan Ini</h3>
                                {PieChart && expenseChartData.length > 0 ? (
                                    <div className="h-72"> {/* Increased height for better visibility */}
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart>
                                                <Pie
                                                    data={expenseChartData}
                                                    cx="50%"
                                                    cy="50%"
                                                    innerRadius={60} // Inner radius for donut effect
                                                    outerRadius={90} // Outer radius
                                                    fill="#8884d8"
                                                    paddingAngle={5}
                                                    dataKey="value"
                                                    label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                                                    animationBegin={0}
                                                    animationDuration={800}
                                                >
                                                    <Tooltip formatter={(value) => formatCurrency(value)} />
                                                    {expenseChartData.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                    ))}
                                                </Pie>
                                                <Legend verticalAlign="bottom" height={36} />
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                ) : (
                                    <p className="text-center text-gray-400 pt-16">Belum ada data pengeluaran bulan ini.</p>
                                )}
                            </div>

                            {/* Tren Keuangan (Line Chart) */}
                            <div className="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-100">
                                <h3 className="font-bold text-xl text-gray-800 mb-4">Tren Keuangan Tahun Ini</h3>
                                {LineChart && financialTrendData.length > 0 ? (
                                    <div className="h-72"> {/* Increased height */}
                                        <ResponsiveContainer width="100%" height="100%">
                                            <LineChart
                                                data={financialTrendData}
                                                margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                                            >
                                                <CartesianGrid strokeDasharray="3 3" stroke="#e0e0e0" />
                                                <XAxis dataKey="name" stroke="#6b7280" />
                                                <YAxis stroke="#6b7280" tickFormatter={(value) => formatCurrency(value)} />
                                                <Tooltip formatter={(value) => formatCurrency(value)} />
                                                <Legend />
                                                <Line type="monotone" dataKey="myPemasukan" stroke="#10B981" activeDot={{ r: 8 }} name="Pemasukan Saya" />
                                                <Line type="monotone" dataKey="myPengeluaran" stroke="#EF4444" activeDot={{ r: 8 }} name="Pengeluaran Saya" />
                                                {partner && (
                                                    <>
                                                        <Line type="monotone" dataKey="partnerPemasukan" stroke="#2563EB" activeDot={{ r: 8 }} name={`Pemasukan ${partner.name || 'Pasangan'}`} />
                                                        <Line type="monotone" dataKey="partnerPengeluaran" stroke="#DC2626" activeDot={{ r: 8 }} name={`Pengeluaran ${partner.name || 'Pasangan'}`} />
                                                    </>
                                                )}
                                                <Line type="monotone" dataKey="saldo" stroke="#3B82F6" activeDot={{ r: 8 }} name="Saldo Bersama" />
                                            </LineChart>
                                        </ResponsiveContainer>
                                    </div>
                                ) : (
                                    <p className="text-center text-gray-400 pt-16">Belum ada data tren keuangan tahun ini.</p>
                                )}
                            </div>
                        </div>

                        {/* Tren Harian Bulan Ini (Daily Chart) */}
                        <div className="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-100">
                            <h3 className="font-bold text-xl text-gray-800 mb-4">Tren Harian Bulan Ini</h3>
                            {LineChart && dailyFinancialTrendData.length > 0 ? (
                                <div className="h-72">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <LineChart
                                            data={dailyFinancialTrendData}
                                            margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                                        >
                                            <CartesianGrid strokeDasharray="3 3" stroke="#e0e0e0" />
                                            <XAxis dataKey="name" stroke="#6b7280" />
                                            <YAxis stroke="#6b7280" tickFormatter={(value) => formatCurrency(value)} />
                                            <Tooltip formatter={(value) => formatCurrency(value)} />
                                            <Legend />
                                            <Line type="monotone" dataKey="pemasukan" stroke="#10B981" activeDot={{ r: 8 }} name="Pemasukan Harian" />
                                            <Line type="monotone" dataKey="pengeluaran" stroke="#EF4444" activeDot={{ r: 8 }} name="Pengeluaran Harian" />
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                            ) : (
                                <p className="text-center text-gray-400 pt-16">Belum ada data tren harian bulan ini.</p>
                            )}
                        </div>

                        {/* Progres Tabungan (Tetap) */}
                        <div className="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-100">
                            <h3 className="font-bold text-xl text-gray-800 mb-4">Progres Tabungan (Total)</h3>
                            <div className="space-y-4">
                                <div className="flex justify-around text-center">
                                    <div>
                                        <p className="text-sm text-gray-500">Total Dana Terkumpul</p>
                                        <p className="text-2xl font-bold text-green-600">{formatCurrency(totalSaved)}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-500">Target Aktif</p>
                                        <p className="text-2xl font-bold text-blue-600">{activeGoals}</p>
                                    </div>
                                </div>
                                {goals.length > 0 ? (
                                    <div className="mt-4">
                                        {goals.map(g => {
                                            const progress = g.targetAmount > 0 ? (g.currentAmount / g.targetAmount) * 100 : 0;
                                            // Calculate estimated time to target
                                            const remaining = g.targetAmount - g.currentAmount;
                                            let estimatedTime = 'N/A';
                                            if (g.monthlyContribution > 0) { // Assuming a monthlyContribution field for estimation
                                                const months = remaining / g.monthlyContribution;
                                                if (months > 0) {
                                                    estimatedTime = `${Math.ceil(months)} bulan`;
                                                } else if (remaining <= 0) {
                                                    estimatedTime = 'Tercapai!';
                                                }
                                            } else if (remaining <= 0) {
                                                estimatedTime = 'Tercapai!';
                                            }

                                            return (
                                                <div key={g.id} className="mb-3">
                                                    <div className="flex justify-between text-sm font-medium">
                                                        <p className="text-gray-700">{g.name}</p>
                                                        <p className="text-green-600">{progress.toFixed(0)}%</p>
                                                    </div>
                                                    <div className="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                                        <div className="bg-green-500 h-2.5 rounded-full transition-all duration-500 ease-out" style={{ width: `${progress > 100 ? 100 : progress}%` }}></div>
                                                    </div>
                                                    <p className="text-xs text-gray-500 mt-1">Estimasi: {estimatedTime}</p>
                                                    {progress >= 100 && (
                                                        <p className="text-sm text-green-700 font-semibold mt-2">🎉 Target Tercapai!</p>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <p className="text-center text-gray-400 mt-8">Belum ada target tabungan.</p>
                                )}
                                <button onClick={() => setActiveTab('savings')} className="w-full mt-4 bg-green-100 text-green-800 font-bold py-2 px-4 rounded-lg hover:bg-green-200 transition duration-200">Lihat Semua Tabungan</button>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        // --- Komponen FinanceTracker ---
        const FinanceTracker = ({ user, ledgerId, selectedDate, setFirestoreError }) => {
            const [transactions, setTransactions] = React.useState([]);
            const [budgets, setBudgets] = React.useState([]); // State for budgets to check against
            const [description, setDescription] = React.useState('');
            const [amount, setAmount] = React.useState('');
            const [type, setType] = React.useState('pengeluaran');
            const [category, setCategory] = React.useState(''); // New state for category
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const monthYear = getMonthYear(selectedDate);

            const defaultCategories = ['Makanan', 'Transportasi', 'Hiburan', 'Tagihan', 'Belanja', 'Lain-lain']; // Example categories

            // Fetch transactions
            React.useEffect(() => {
                if (!user || !ledgerId || !db) {
                    setIsLoading(false);
                    setTransactions([]);
                    return;
                }
                setIsLoading(true);
                const collectionPath = `ledgers/${ledgerId}/transactions`;
                const q = query(collection(db, collectionPath), where('monthYear', '==', monthYear));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const newTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => {
                        const dateA = a.createdAt && typeof a.createdAt.toDate === 'function' ? a.createdAt.toDate() : new Date(0);
                        const dateB = b.createdAt && typeof b.createdAt.toDate === 'function' ? b.createdAt.toDate() : new Date(0);
                        return dateB - dateA;
                    });
                    setTransactions(newTransactions);
                    setIsLoading(false);
                }, (err) => {
                    console.error("Firestore Error:", err);
                    if (err.code === 'permission-denied') {
                        setFirestoreError("Kesalahan Izin: Gagal memuat transaksi. Pastikan Aturan Keamanan Firestore Anda mengizinkan akses untuk ledger ini. Silakan periksa Firebase Console Anda.");
                    }
                    setError("Gagal memuat data transaksi.");
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [user, ledgerId, monthYear, setFirestoreError]);

            // Fetch budgets for the current month
            React.useEffect(() => {
                if (!user || !ledgerId || !db) { setBudgets([]); return; }
                const budgetCollectionPath = `ledgers/${ledgerId}/budgets`;
                const q = query(collection(db, budgetCollectionPath), where('monthYear', '==', monthYear));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setBudgets(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (err) => {
                    console.error("Firestore Error fetching budgets for FinanceTracker:", err);
                });
                return () => unsubscribe();
            }, [user, ledgerId, monthYear]);


            const addTransaction = async (e) => {
                e.preventDefault();
                if (!description || !amount || !user || !user.uid || !ledgerId || !db) {
                    setError("Deskripsi, jumlah, atau informasi pengguna tidak lengkap.");
                    return;
                }
                try {
                    await addDoc(collection(db, `ledgers/${ledgerId}/transactions`), {
                        description,
                        amount: Number(amount),
                        type,
                        category: category || 'Lain-lain',
                        userId: user.uid,
                        userName: user.name || 'Anonim',
                        createdAt: serverTimestamp(),
                        monthYear: monthYear
                    });

                    // Update budget if it's an expense and a category is selected
                    if (type === 'pengeluaran' && category) {
                        const existingBudget = budgets.find(b => b.name === category && b.monthYear === monthYear);
                        if (existingBudget) {
                            await updateDoc(doc(db, `ledgers/${ledgerId}/budgets/${existingBudget.id}`), {
                                spentAmount: increment(Number(amount)) // Add to spentAmount
                            });
                        } else {
                            // If budget category doesn't exist, create it as an expense
                            await addDoc(collection(db, `ledgers/${ledgerId}/budgets`), {
                                name: category,
                                budgetAmount: 0, // No planned budget, just track spent
                                spentAmount: Number(amount),
                                monthYear: monthYear,
                                userId: user.uid, // User who added the expense
                                userName: user.name || 'Anonim',
                                createdAt: serverTimestamp()
                            });
                        }
                    }

                    setDescription('');
                    setAmount('');
                    setCategory('');
                    setError('');
                } catch (err) {
                    console.error("Error adding transaction:", err);
                    setError("Gagal menambah transaksi.");
                }
            };

            const deleteTransaction = async (id, transactionType, transactionAmount, transactionCategory) => {
                if (!db) return;
                try {
                    await deleteDoc(doc(db, `ledgers/${ledgerId}/transactions/${id}`));

                    // Revert budget if it was an expense
                    if (transactionType === 'pengeluaran' && transactionCategory) {
                        const existingBudget = budgets.find(b => b.name === transactionCategory && b.monthYear === monthYear);
                        if (existingBudget) {
                            await updateDoc(doc(db, `ledgers/${ledgerId}/budgets/${existingBudget.id}`), {
                                spentAmount: increment(-Number(transactionAmount)) // Subtract from spentAmount
                            });
                        }
                    }
                } catch (err) {
                    console.error("Error deleting transaction:", err);
                    setError("Gagal menghapus transaksi.");
                }
            };

            // Calculate current month's financials for the card
            const { totalIncome, totalExpense, balance } = React.useMemo(() => {
                const income = transactions.filter(t => t.type === 'pemasukan').reduce((sum, t) => sum + Number(t.amount), 0);
                const expense = transactions.filter(t => t.type === 'pengeluaran').reduce((sum, t) => sum + Number(t.amount), 0);
                return { totalIncome: income, totalExpense: expense, balance: income - expense };
            }, [transactions]);

            return (
                <>
                    {/* Financial Summary Card */}
                    <div className="bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-xl shadow-custom-card-blue p-6 mb-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Ringkasan Keuangan</h2>
                            <WalletIcon className="h-8 w-8 text-blue-200" />
                        </div>
                        <div className="text-right">
                            <p className="text-sm opacity-80">Saldo Bersih Bulan Ini</p>
                            <p className="text-3xl font-bold">{formatCurrency(balance)}</p>
                        </div>
                        <div className="flex justify-between mt-4 text-sm">
                            <div>
                                <p className="opacity-80">Pemasukan</p>
                                <p className="font-semibold">{formatCurrency(totalIncome)}</p>
                            </div>
                            <div>
                                <p className="opacity-80">Pengeluaran</p>
                                <p className="font-semibold">{formatCurrency(totalExpense)}</p>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Tambah Transaksi Baru</h2>
                        <form onSubmit={addTransaction} className="space-y-4">
                            <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} placeholder="Contoh: Belanja bulanan" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200" required />
                            <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="Jumlah (misal: 50000)" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200" required />
                            <select value={category} onChange={(e) => setCategory(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                                <option value="">Pilih Kategori</option>
                                {defaultCategories.map(cat => (
                                    <option key={cat} value={cat}>{cat}</option>
                                ))}
                            </select>
                            <div className="flex space-x-4">
                                <label className={`flex-1 flex items-center justify-center p-3 border rounded-lg cursor-pointer transition duration-200 ${type === 'pengeluaran' ? 'bg-blue-100 border-blue-500 text-blue-800 shadow-sm' : 'bg-white hover:bg-gray-50'}`}>
                                    <input type="radio" name="type" value="pengeluaran" checked={type === 'pengeluaran'} onChange={(e) => setType(e.target.value)} className="hidden" />
                                    <span>Pengeluaran</span>
                                </label>
                                <label className={`flex-1 flex items-center justify-center p-3 border rounded-lg cursor-pointer transition duration-200 ${type === 'pemasukan' ? 'bg-green-100 border-green-500 text-green-800 shadow-sm' : 'bg-white hover:bg-gray-50'}`}>
                                    <input type="radio" name="type" value="pemasukan" checked={type === 'pemasukan'} onChange={(e) => setType(e.target.value)} className="hidden" />
                                    <span>Pemasukan</span>
                                </label>
                            </div>
                            <button type="submit" className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:from-blue-600 hover:to-blue-700 transition duration-300 flex items-center justify-center shadow-custom-blue">
                                <PlusIcon /><span>Tambah</span>
                            </button>
                        </form>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    </div>

                    {/* Budget Summary for current month within FinanceTracker */}
                    <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Ringkasan Anggaran Bulan Ini</h2>
                        {budgets.length === 0 ? (
                            <p className="text-center text-gray-500">Belum ada anggaran yang diatur untuk bulan ini.</p>
                        ) : (
                            <div className="space-y-4">
                                {budgets.map(budget => {
                                    const spent = transactions
                                        .filter(t => t.category === budget.name && t.monthYear === monthYear && t.type === 'pengeluaran')
                                        .reduce((sum, t) => sum + Number(t.amount), 0);
                                    const remaining = budget.budgetAmount - spent;
                                    const progress = (spent / budget.budgetAmount) * 100;
                                    const isOverBudget = remaining < 0;

                                    return (
                                        <div key={budget.id} className="bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-4">
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <p className="font-semibold text-gray-800">{budget.name}</p>
                                                    <p className="text-sm text-gray-600">Anggaran: {formatCurrency(budget.budgetAmount)}</p>
                                                    <p className="text-sm text-gray-600">Terpakai: {formatCurrency(spent)}</p>
                                                    <p className={`text-sm font-medium ${isOverBudget ? 'text-red-600' : 'text-green-600'}`}>Sisa: {formatCurrency(remaining)}</p>
                                                </div>
                                                <button onClick={() => deleteDoc(doc(db, `ledgers/${ledgerId}/budgets/${budget.id}`))} className="text-gray-400 hover:text-red-500 p-1 rounded-full transition duration-200"><TrashIcon /></button>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-2.5 my-2">
                                                <div className={`h-2.5 rounded-full transition-all duration-500 ease-out ${isOverBudget ? 'bg-red-500' : 'bg-blue-500'}`} style={{ width: `${progress > 100 ? 100 : progress}%` }}></div>
                                            </div>
                                            {isOverBudget && <p className="text-xs text-red-500 mt-1">Anda melebihi anggaran untuk kategori ini!</p>}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        <button onClick={() => {
                                const categoryName = prompt("Masukkan nama kategori anggaran baru:");
                                const budgetAmount = prompt("Masukkan jumlah anggaran untuk kategori ini:");
                                if (categoryName && budgetAmount && !isNaN(Number(budgetAmount))) {
                                    addDoc(collection(db, `ledgers/${ledgerId}/budgets`), {
                                        name: categoryName,
                                        budgetAmount: Number(budgetAmount),
                                        spentAmount: 0, // Initialize spent amount for new budget
                                        monthYear: monthYear,
                                        userId: user.uid,
                                        userName: user.name || 'Anonim',
                                        createdAt: serverTimestamp()
                                    }).catch(err => console.error("Error adding budget from prompt:", err));
                                } else if (categoryName || budgetAmount) {
                                    alert("Input tidak valid. Nama kategori dan jumlah anggaran harus diisi dengan benar.");
                                }
                            }} className="w-full mt-4 bg-blue-100 text-blue-800 font-bold py-2 px-4 rounded-lg hover:bg-blue-200 transition duration-200">
                            Atur Anggaran Baru
                        </button>
                    </div>

                    <div>
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Riwayat Transaksi - {selectedDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}</h2>
                        {isLoading ? <p className="text-center text-gray-500">Memuat data...</p> : transactions.length === 0 ? <div className="text-center bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-8 border border-gray-100"><p className="text-gray-500">Belum ada transaksi bulan ini. Tambahkan transaksi pertama Anda di atas!</p></div> : (
                            <div className="space-y-3">
                                {transactions.filter(t => getMonthYear(selectedDate) === t.monthYear).map(t => ( // Filter for current month only
                                    <div key={t.id} className="bg-white/90 backdrop-blur-sm rounded-xl shadow-md p-4 flex items-center justify-between border border-gray-100">
                                        <div>
                                            <p className="font-semibold text-gray-800">{t.description}</p>
                                            <p className="text-sm text-gray-500">{t.category && `Kategori: ${t.category} | `}{t.userName || 'Anonim'} pada {t.createdAt && typeof t.createdAt.toDate === 'function' ? new Date(t.createdAt.toDate()).toLocaleDateString('id-ID') : 'Baru'}</p>
                                        </div>
                                        <div className="flex items-center space-x-4">
                                            <p className={`font-bold ${t.type === 'pemasukan' ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(t.amount)}</p>
                                            <button onClick={() => deleteTransaction(t.id, t.type, t.amount, t.category)} className="text-gray-400 hover:text-red-500 p-2 rounded-full transition duration-200"><TrashIcon /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </>
            );
        };

        // --- Komponen Pelacak Kebiasaan ---
        const HabitTracker = ({ user, ledgerId, selectedDate, requestNotificationPermission, setFirestoreError }) => {
            const [habits, setHabits] = React.useState([]);
            const [newHabitName, setNewHabitName] = React.useState('');
            const [newHabitTime, setNewHabitTime] = React.useState(''); // New state for reminder time
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const monthYear = getMonthYear(selectedDate);

            const daysInMonth = React.useMemo(() => new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0).getDate(), [selectedDate]);
            const daysArray = Array.from({ length: daysInMonth }, (_, i) => i + 1);

            // Helper function to get short day name (e.g., "Sen", "Sel")
            const getShortDayName = (year, month, day) => {
                const date = new Date(year, month, day);
                return date.toLocaleDateString('id-ID', { weekday: 'short' });
            };

            const scheduleHabitNotification = (title, day, time) => {
                if (Notification.permission === "granted") {
                    const year = selectedDate.getFullYear();
                    const month = selectedDate.getMonth();
                    const [hours, minutes] = time.split(':').map(Number);
                    const notificationTime = new Date(year, month, day, hours, minutes, 0);
                    const now = new Date();

                    if (notificationTime > now) {
                        const delay = notificationTime.getTime() - now.getTime();
                        setTimeout(() => {
                            new Notification('Pengingat Kebiasaan', {
                                body: `Waktunya untuk: ${title} hari ini!`,
                                icon: 'https://placehold.co/40x40/E2E8F0/4A5568?text=⏰' // Placeholder icon
                            });
                        }, delay);
                        console.log(`Notifikasi kebiasaan dijadwalkan untuk: ${title} pada ${notificationTime}`);
                    } else {
                        console.log(`Waktu pengingat kebiasaan untuk "${title}" sudah lewat.`);
                    }
                } else if (Notification.permission === "denied") {
                    // Replaced alert with console.log as per new instructions
                    console.log("Izin notifikasi ditolak. Silakan izinkan notifikasi di pengaturan browser Anda untuk pengingat kebiasaan.");
                } else {
                    requestNotificationPermission();
                }
            };

            React.useEffect(() => {
                if (!user || !ledgerId || !db) { setIsLoading(false); setHabits([]); return; }
                setIsLoading(true);
                const collectionPath = `ledgers/${ledgerId}/habits`;
                const q = query(collection(db, collectionPath));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedHabits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setHabits(fetchedHabits);
                    setIsLoading(false);

                    // Schedule notifications for habits if time is set
                    fetchedHabits.forEach(habit => {
                        if (habit.reminderTime) {
                            // Only schedule for today or future days in the current month
                            const today = new Date();
                            const currentMonth = selectedDate.getMonth();
                            for (let day = 1; day <= daysInMonth; day++) {
                                const eventDate = new Date(selectedDate.getFullYear(), currentMonth, day);
                                if (eventDate.getTime() >= today.setHours(0,0,0,0)) { // Only schedule for today or future days
                                    scheduleHabitNotification(habit.name, day, habit.reminderTime);
                                }
                            }
                        }
                    });

                }, (err) => {
                    console.error("Firestore Error:", err);
                    if (err.code === 'permission-denied') {
                        setFirestoreError("Kesalahan Izin: Gagal memuat kebiasaan. Pastikan Aturan Keamanan Firestore Anda mengizinkan akses untuk ledger ini. Silakan periksa Firebase Console Anda.");
                    }
                    setError("Gagal memuat data kebiasaan.");
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [user, ledgerId, selectedDate, setFirestoreError]);

            const addHabit = async (e) => {
                e.preventDefault();
                // Ensure user and user.uid exist before adding habit
                if (!newHabitName || !user || !user.uid || !ledgerId || !db) {
                    setError("Nama kebiasaan atau informasi pengguna tidak lengkap.");
                    return;
                }
                try {
                    const habitData = {
                        name: newHabitName,
                        completions: [],
                        createdAt: serverTimestamp(),
                        userId: user.uid,
                        userName: user.name || 'Anonim' // Store userName with habit
                    };
                    if (newHabitTime) {
                        habitData.reminderTime = newHabitTime;
                    }

                    await addDoc(collection(db, `ledgers/${ledgerId}/habits`), removeUndefined(habitData));
                    setNewHabitName(''); setNewHabitTime(''); setError('');
                } catch (err) { console.error("Error adding habit:", err); setError("Gagal menambah kebiasaan."); }
            };

            const toggleHabitCompletion = async (habit, day) => {
                if (!db) return;
                const dateString = `${monthYear}-${String(day).padStart(2, '0')}`;
                const currentCompletions = habit.completions || [];
                const isDone = currentCompletions.includes(dateString);
                const newCompletions = isDone ? arrayRemove(dateString) : arrayUnion(dateString);

                // Store who completed it
                const currentCompletedBy = habit.completedBy || {};
                const newCompletedBy = { ...currentCompletedBy };

                if (isDone) {
                    delete newCompletedBy[dateString]; // Remove entry for this day
                } else {
                    newCompletedBy[dateString] = user.name ? user.name.substring(0, 1).toUpperCase() : '?'; // Store first letter of user's name
                }

                try {
                    await updateDoc(doc(db, `ledgers/${ledgerId}/habits/${habit.id}`), {
                        completions: newCompletions,
                        completedBy: newCompletedBy
                    });
                } catch (err) {
                    console.error("Error toggling habit:", err);
                }
            };
            
            const deleteHabit = async (id) => {
                if (!db) return;
                try { await deleteDoc(doc(db, `ledgers/${ledgerId}/habits/${id}`)); } catch (err) { console.error("Error deleting habit:", err); }
            };

            // Group habits by name to combine duplicates
            const groupedHabits = React.useMemo(() => {
                const groups = {};
                habits.forEach(h => {
                    if (!groups[h.name]) {
                        groups[h.name] = {
                            name: h.name,
                            ids: [],
                            completions: [],
                            completedBy: {},
                            reminderTime: h.reminderTime,
                            users: [] // To store unique users for this habit
                        };
                    }
                    groups[h.name].ids.push(h.id);
                    groups[h.name].users.push(h.userName || 'Anonim');
                    // Merge completions and completedBy from all habits with the same name
                    (h.completions || []).forEach(comp => {
                        if (!groups[h.name].completions.includes(comp)) {
                            groups[h.name].completions.push(comp);
                        }
                    });
                    // Merge completedBy, prioritize current user's completion if available
                    for (const dateString in h.completedBy) {
                        groups[h.name].completedBy[dateString] = h.completedBy[dateString];
                    }
                });
                // Ensure unique users
                for (const name in groups) {
                    groups[name].users = [...new Set(groups[name].users)];
                }
                return Object.values(groups);
            }, [habits]);


            // Calculate daily progress percentage
            const dailyProgress = React.useMemo(() => {
                const progress = {};
                const totalHabits = groupedHabits.length; // Use groupedHabits for total count
                if (totalHabits === 0) {
                    for (let i = 1; i <= daysInMonth; i++) {
                        progress[i] = 0;
                    }
                    return progress;
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateString = `${monthYear}-${String(day).padStart(2, '0')}`;
                    let completedCount = 0;
                    groupedHabits.forEach(h => { // Iterate through grouped habits
                        if ((h.completions || []).includes(dateString)) {
                            completedCount++;
                        }
                    });
                    progress[day] = (completedCount / totalHabits) * 100;
                }
                return progress;
            }, [groupedHabits, daysInMonth, monthYear]);

            // Calculate monthly completion rate for each habit
            const monthlyCompletionRate = React.useMemo(() => {
                const rates = {};
                groupedHabits.forEach(h => { // Use groupedHabits
                    const completedInMonth = (h.completions || []).filter(dateStr => dateStr.startsWith(monthYear)).length;
                    rates[h.name] = (completedInMonth / daysInMonth) * 100;
                });
                return rates;
            }, [groupedHabits, daysInMonth, monthYear]);

            // Calculate streak for each grouped habit
            const calculateGroupedStreak = (completions) => {
                if (!completions || completions.length === 0) return 0;

                let streak = 0;
                let currentDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
                let todayString = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;

                if (completions.includes(todayString)) {
                    streak = 1;
                } else {
                    currentDate.setDate(currentDate.getDate() - 1);
                    todayString = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                    if (!completions.includes(todayString)) {
                        return 0;
                    }
                }

                while (true) {
                    currentDate.setDate(currentDate.getDate() - 1);
                    const prevDayString = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                    if (completions.includes(prevDayString)) {
                        streak++;
                    } else {
                        break;
                    }
                }
                return streak;
            };


            return (
                <>
                    <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Tambah Kebiasaan Baru</h2>
                        <form onSubmit={addHabit} className="flex flex-col space-y-3">
                            <input type="text" value={newHabitName} onChange={(e) => setNewHabitName(e.target.value)} placeholder="Contoh: Olahraga 15 menit" className="w-full p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-200" required />
                            <input type="time" value={newHabitTime} onChange={(e) => setNewHabitTime(e.target.value)} placeholder="Waktu Pengingat (opsional)" className="w-full p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-200" />
                            <button type="submit" className="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:from-purple-600 hover:to-purple-700 transition duration-300 shadow-custom-purple"><PlusIcon /><span>Tambah</span></button>
                        </form>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    </div>
                    <div>
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Tabel Kebiasaan - {selectedDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}</h2>
                        {isLoading ? <p>Memuat...</p> : groupedHabits.length === 0 ? <div className="text-center bg-white/90 backdrop-blur-sm rounded-xl p-8 border border-gray-100"><p className="text-gray-500">Belum ada kebiasaan. Tambahkan kebiasaan pertama Anda di atas!</p></div> : (
                            <div className="overflow-x-auto bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-4 border border-gray-100">
                                <table className="w-full border-collapse text-sm text-center">
                                    <thead>
                                        <tr className="bg-gray-50">
                                            <th className="p-2 sticky left-0 bg-gray-50 z-10">Kebiasaan</th>
                                            {daysArray.map(day => (
                                                <th key={day} className="p-2 w-10">
                                                    <div className="flex flex-col items-center">
                                                        <span>{getShortDayName(selectedDate.getFullYear(), selectedDate.getMonth(), day)}</span>
                                                        <span className="text-xs font-normal text-gray-500">{day}</span>
                                                    </div>
                                                </th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {groupedHabits.map(h => (
                                            <tr key={h.name} className="border-b last:border-b-0"> {/* Use h.name as key for grouped habits */}
                                                <td className="p-2 text-left font-semibold sticky left-0 bg-white/90 backdrop-blur-sm flex items-center justify-between z-10">
                                                    <div className="flex flex-col items-start">
                                                        <span className="truncate pr-2 text-gray-800">{h.name} {h.reminderTime ? `(${h.reminderTime})` : ''}</span>
                                                        <span className="text-xs text-gray-500">Oleh: {h.users.join(', ')}</span> {/* Display all users */}
                                                        <span className="text-xs text-blue-500">Streak: {calculateGroupedStreak(h.completions)} hari</span>
                                                        <span className="text-xs text-green-500">Bulan Ini: {monthlyCompletionRate[h.name].toFixed(0)}%</span>
                                                    </div>
                                                    {/* Delete button for the first habit in the group, or consider a group delete */}
                                                    <button onClick={() => deleteHabit(h.ids[0])} className="text-gray-400 hover:text-red-500 transition duration-200"><TrashIcon /></button>
                                                </td>
                                                {daysArray.map(day => {
                                                    const dateString = `${monthYear}-${String(day).padStart(2, '0')}`;
                                                    const completedByThisDay = h.completedBy[dateString];
                                                    const isDone = (h.completions || []).includes(dateString);
                                                    return (
                                                        <td key={day} className="p-2 border-l border-gray-100">
                                                            <div className="flex flex-col items-center justify-center">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={isDone}
                                                                    onChange={() => toggleHabitCompletion(h, day)}
                                                                    className="w-5 h-5 rounded text-purple-600 focus:ring-purple-500 cursor-pointer transition duration-200"
                                                                />
                                                                {completedByThisDay && (
                                                                    <span className="text-xs text-gray-500 mt-0.5">
                                                                        {completedByThisDay} {/* Display first letter of name */}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot>
                                        <tr className="bg-gray-100 font-bold">
                                            <td className="p-2 text-left sticky left-0 bg-gray-100 z-10 text-gray-700">Progres Harian (%)</td>
                                            {daysArray.map(day => (
                                                <td key={`progress-${day}`} className="p-2 border-l border-gray-200 text-gray-800">
                                                    {dailyProgress[day].toFixed(0)}%
                                                </td>
                                            ))}
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        )}
                    </div>
                </>
            );
        };

        // --- Komponen Pelacak Tabungan ---
        const SavingsTracker = ({ user, ledgerId, setFirestoreError }) => {
            const [goals, setGoals] = React.useState([]);
            const [newGoalName, setNewGoalName] = React.useState('');
            const [newTargetAmount, setNewTargetAmount] = React.useState('');
            const [newMonthlyContribution, setNewMonthlyContribution] = React.useState(''); // New field for monthly contribution
            const [amountToAdd, setAmountToAdd] = React.useState({});
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');

            React.useEffect(() => {
                if (!user || !ledgerId || !db) {
                    setIsLoading(false);
                    setGoals([]);
                    return;
                }
                setIsLoading(true);
                const collectionPath = `ledgers/${ledgerId}/savings`;
                const q = query(collection(db, collectionPath));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setGoals(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setIsLoading(false);
                }, (err) => {
                    console.error("Firestore Error:", err);
                    if (err.code === 'permission-denied') {
                        setFirestoreError("Kesalahan Izin: Gagal memuat target tabungan. Pastikan Aturan Keamanan Firestore Anda mengizinkan akses untuk ledger ini. Silakan periksa Firebase Console Anda.");
                    }
                    setError("Gagal memuat data tabungan.");
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [user, ledgerId, setFirestoreError]);

            const addGoal = async (e) => {
                e.preventDefault();
                // Ensure user and user.uid exist before adding goal
                if (!newGoalName || !newTargetAmount || !user || !user.uid || !ledgerId || !db) {
                    setError("Nama target, jumlah target, atau informasi pengguna tidak lengkap.");
                    return;
                }
                try {
                    await addDoc(collection(db, `ledgers/${ledgerId}/savings`), {
                        name: newGoalName,
                        targetAmount: Number(newTargetAmount),
                        currentAmount: 0,
                        monthlyContribution: Number(newMonthlyContribution) || 0, // Save monthly contribution
                        createdAt: serverTimestamp(),
                        userId: user.uid,
                        userName: user.name || 'Anonim' // Store userName with goal
                    });
                    setNewGoalName('');
                    setNewTargetAmount('');
                    setNewMonthlyContribution(''); // Reset monthly contribution
                    setError('');
                } catch (err) {
                    console.error("Error adding goal:", err);
                    setError("Gagal menambah target tabungan.");
                }
            };

            const addFunds = async (goalId) => {
                if (!db) return;
                const amount = Number(amountToAdd[goalId] || 0);
                if (amount <= 0) {
                    setError("Jumlah harus lebih besar dari nol.");
                    return;
                }
                try {
                    await updateDoc(doc(db, `ledgers/${ledgerId}/savings/${goalId}`), { currentAmount: increment(amount) });
                    setAmountToAdd(prev => ({ ...prev, [goalId]: '' }));
                    setError('');
                } catch (err) {
                    console.error("Error adding funds:", err);
                    setError("Gagal menambah dana.");
                }
            };

            const deleteGoal = async (id) => {
                if (!db) return;
                try {
                    await deleteDoc(doc(db, `ledgers/${ledgerId}/savings/${id}`));
                } catch (err) {
                    console.error("Error deleting goal:", err);
                    setError("Gagal menghapus target.");
                }
            };

            // Calculate total saved and total target for the card
            const { totalSaved, totalTarget } = React.useMemo(() => {
                const saved = goals.reduce((sum, g) => sum + Number(g.currentAmount), 0);
                const target = goals.reduce((sum, g) => sum + Number(g.targetAmount), 0);
                return { totalSaved: saved, totalTarget: target };
            }, [goals]);


            return (
                <>
                    {/* Savings Summary Card */}
                    <div className="bg-gradient-to-br from-green-500 to-green-700 text-white rounded-xl shadow-custom-card-green p-6 mb-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Ringkasan Tabungan</h2>
                            <PiggyBankIcon className="h-8 w-8 text-green-200" />
                        </div>
                        <div className="text-right">
                            <p className="text-sm opacity-80">Total Dana Terkumpul</p>
                            <p className="text-3xl font-bold">{formatCurrency(totalSaved)}</p>
                        </div>
                        <div className="flex justify-between mt-4 text-sm">
                            <div>
                                <p className="opacity-80">Total Target</p>
                                <p className="font-semibold">{formatCurrency(totalTarget)}</p>
                            </div>
                            <div>
                                <p className="opacity-80">Target Aktif</p>
                                <p className="font-semibold">{goals.length}</p>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Tambah Target Tabungan Baru</h2>
                        <form onSubmit={addGoal} className="space-y-3">
                            <input type="text" value={newGoalName} onChange={(e) => setNewGoalName(e.target.value)} placeholder="Contoh: Dana liburan" className="w-full p-3 border rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-200" required />
                            <input type="number" value={newTargetAmount} onChange={(e) => setNewTargetAmount(e.target.value)} placeholder="Target (misal: 5000000)" className="w-full p-3 border rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-200" required />
                            <input type="number" value={newMonthlyContribution} onChange={(e) => setNewMonthlyContribution(e.target.value)} placeholder="Kontribusi Bulanan (opsional)" className="w-full p-3 border rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-200" />
                            <button type="submit" className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-3 px-4 rounded-lg hover:from-green-600 hover:to-green-700 transition duration-300 shadow-custom-green">
                                <PlusIcon /><span>Tambah Target</span>
                            </button>
                        </form>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    </div>
                    <div>
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Daftar Target Tabungan</h2>
                        {isLoading ? <p>Memuat...</p> : goals.length === 0 ? <div className="text-center bg-white/90 backdrop-blur-sm rounded-xl p-8 border border-gray-100"><p className="text-gray-500">Belum ada target. Tambahkan target tabungan impian Anda di atas!</p></div> : (
                            <div className="space-y-4">
                                {goals.map(g => {
                                    const progress = g.targetAmount > 0 ? (g.currentAmount / g.targetAmount) * 100 : 0;
                                    // Calculate estimated time to target
                                    const remaining = g.targetAmount - g.currentAmount;
                                    let estimatedTime = 'N/A';
                                    if (g.monthlyContribution > 0) {
                                        const months = remaining / g.monthlyContribution;
                                        if (months > 0) {
                                            estimatedTime = `${Math.ceil(months)} bulan`;
                                        } else if (remaining <= 0) {
                                            estimatedTime = 'Tercapai!';
                                        }
                                    } else if (remaining <= 0) {
                                        estimatedTime = 'Tercapai!';
                                    }

                                    return (
                                        <div key={g.id} className="bg-white/90 backdrop-blur-sm rounded-xl shadow-md p-4 border border-gray-100">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <p className="font-semibold text-gray-800">{g.name}</p>
                                                    <p className="text-sm text-green-600 font-medium">{formatCurrency(g.currentAmount)} / {formatCurrency(g.targetAmount)}</p>
                                                    <p className="text-xs text-gray-500">Oleh: {g.userName || 'Anonim'}</p>
                                                    {g.monthlyContribution > 0 && <p className="text-xs text-gray-500">Kontribusi Bulanan: {formatCurrency(g.monthlyContribution)}</p>}
                                                    <p className="text-xs text-gray-500">Estimasi Capai: {estimatedTime}</p>
                                                </div>
                                                <button onClick={() => deleteGoal(g.id)} className="text-gray-400 hover:text-red-500 p-1 rounded-full transition duration-200"><TrashIcon /></button>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-2.5 my-2">
                                                <div className="bg-green-500 h-2.5 rounded-full transition-all duration-500 ease-out" style={{ width: `${progress > 100 ? 100 : progress}%` }}></div>
                                            </div>
                                            {progress >= 100 && (
                                                <p className="text-sm text-green-700 font-semibold mt-2">🎉 Target Tercapai!</p>
                                            )}
                                            <div className="flex space-x-2 mt-3">
                                                <input type="number" value={amountToAdd[g.id] || ''} onChange={(e) => setAmountToAdd(prev => ({ ...prev, [g.id]: e.target.value }))} placeholder="Jumlah" className="flex-grow p-2 border rounded-lg text-sm focus:ring-green-500 focus:border-green-500 transition duration-200" />
                                                <button onClick={() => addFunds(g.id)} className="bg-gray-200 font-semibold p-2 rounded-lg hover:bg-gray-300 text-sm transition duration-200">Tambah</button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </>
            );
        };

        // --- Komponen TravelWishlist (Baru) ---
        const TravelWishlist = ({ user, ledgerId, setFirestoreError }) => {
            const [wishlistItems, setWishlistItems] = React.useState([]);
            const [newDestination, setNewDestination] = React.useState('');
            const [newDescription, setNewDescription] = React.useState('');
            const [newEstimatedCost, setNewEstimatedCost] = React.useState(''); // New field
            const [newLinkedSavingsGoal, setNewLinkedSavingsGoal] = React.useState(''); // New field
            const [newPhoto, setNewPhoto] = React.useState(null); // Base64 string
            const [photoPreview, setPhotoPreview] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const fileInputRef = React.useRef();

            React.useEffect(() => {
                if (!user || !ledgerId || !db) { setIsLoading(false); setWishlistItems([]); return; }
                setIsLoading(true);
                const collectionPath = `ledgers/${ledgerId}/travelWishlist`;
                const q = query(collection(db, collectionPath));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setWishlistItems(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setIsLoading(false);
                }, (err) => {
                    console.error("Firestore Error:", err);
                    if (err.code === 'permission-denied') {
                        setFirestoreError("Kesalahan Izin: Gagal memuat wishlist perjalanan. Pastikan Aturan Keamanan Firestore Anda mengizinkan akses untuk ledger ini. Silakan periksa Firebase Console Anda.");
                    }
                    setError("Gagal memuat wishlist.");
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [user, ledgerId, setFirestoreError]);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setNewPhoto(reader.result); // Base64 string
                        setPhotoPreview(reader.result);
                    };
                    reader.readAsDataURL(file);
                } else {
                    setNewPhoto(null);
                    setPhotoPreview(null);
                }
            };

            const addWishlistItem = async (e) => {
                e.preventDefault();
                if (!newDestination || !user || !ledgerId || !db) return;
                try {
                    await addDoc(collection(db, `ledgers/${ledgerId}/travelWishlist`), {
                        destination: newDestination,
                        description: newDescription,
                        estimatedCost: Number(newEstimatedCost) || 0, // Save estimated cost
                        linkedSavingsGoal: newLinkedSavingsGoal || null, // Save linked savings goal
                        photoBase64: newPhoto || null, // Store Base64 or null
                        visited: false, // New field: default to false
                        userId: user.uid,
                        userName: user.name || 'Anonim',
                        createdAt: serverTimestamp()
                    });
                    setNewDestination(''); setNewDescription(''); setNewEstimatedCost(''); setNewLinkedSavingsGoal(''); setNewPhoto(null); setPhotoPreview(null); setError('');
                    if (fileInputRef.current) fileInputRef.current.value = ''; // Clear file input
                } catch (err) { console.error("Error adding wishlist item:", err); setError("Gagal menambah item wishlist."); }
            };

            const toggleVisitedStatus = async (item) => {
                if (!db) return;
                try {
                    await updateDoc(doc(db, `ledgers/${ledgerId}/travelWishlist/${item.id}`), {
                        visited: !item.visited
                    });
                } catch (err) {
                    console.error("Error toggling visited status:", err);
                    setError("Gagal memperbarui status kunjungan.");
                }
            };

            const deleteWishlistItem = async (id) => {
                if(!db) return;
                try { await deleteDoc(doc(db, `ledgers/${ledgerId}/travelWishlist/${id}`)); } catch (err) { console.error("Error deleting wishlist item:", err); setError("Gagal menghapus item wishlist."); }
            };

            return (
                <>
                    <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Tambah Tempat Liburan Impian</h2>
                        <form onSubmit={addWishlistItem} className="space-y-4">
                            <input type="text" value={newDestination} onChange={(e) => setNewDestination(e.target.value)} placeholder="Destinasi (misal: Bali, Tokyo)" className="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200" required />
                            <textarea value={newDescription} onChange={(e) => setNewDescription(e.target.value)} placeholder="Mengapa Anda ingin pergi ke sana?" className="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 min-h-[80px]"></textarea>
                            <input type="number" value={newEstimatedCost} onChange={(e) => setNewEstimatedCost(e.target.value)} placeholder="Estimasi Biaya (misal: 10000000)" className="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200" />
                            <input type="text" value={newLinkedSavingsGoal} onChange={(e) => setNewLinkedSavingsGoal(e.target.value)} placeholder="Tautan ke Target Tabungan (opsional)" className="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200" />
                            <div className="flex items-center space-x-4">
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                                {photoPreview && (
                                    <img src={photoPreview} alt="Pratinjau Foto" className="w-20 h-20 object-cover rounded-lg border border-gray-200" />
                                )}
                            </div>
                            <button type="submit" className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:from-blue-600 hover:to-blue-700 transition duration-300 flex items-center justify-center shadow-custom-blue">
                                <PlusIcon /><span>Tambah Wishlist</span>
                            </button>
                        </form>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    </div>

                    <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 border border-gray-100">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Daftar Wishlist Liburan Anda</h2>
                        {isLoading ? <p className="text-center text-gray-500">Memuat wishlist...</p> : wishlistItems.length === 0 ? <div className="text-center text-gray-500 p-8">Belum ada tempat liburan di wishlist Anda. Tambahkan destinasi impian Anda di atas!</div> : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {wishlistItems.map(item => (
                                    <div key={item.id} className="bg-gray-50 rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                        {item.photoBase64 && (
                                            <img src={item.photoBase64} alt={item.destination} className="w-full h-40 object-cover" />
                                        )}
                                        <div className="p-4">
                                            <div className="flex justify-between items-start mb-2">
                                                <h3 className={`font-bold text-lg text-gray-800 ${item.visited ? 'line-through text-gray-500' : ''}`}>{item.destination}</h3>
                                                <div className="flex items-center space-x-2">
                                                    <input
                                                        type="checkbox"
                                                        checked={item.visited || false}
                                                        onChange={() => toggleVisitedStatus(item)}
                                                        className="h-5 w-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer"
                                                        title={item.visited ? "Sudah Dikunjungi" : "Tandai Sudah Dikunjungi"}
                                                    />
                                                    <button onClick={() => deleteWishlistItem(item.id)} className="text-gray-400 hover:text-red-500 transition duration-200">
                                                        <TrashIcon />
                                                    </button>
                                                </div>
                                            </div>
                                            <p className={`text-sm text-gray-700 mb-2 ${item.visited ? 'line-through text-gray-500' : ''}`}>{item.description}</p>
                                            {item.estimatedCost > 0 && <p className="text-sm text-gray-700">Estimasi Biaya: {formatCurrency(item.estimatedCost)}</p>}
                                            {item.linkedSavingsGoal && <p className="text-sm text-gray-700">Terkait Tabungan: {item.linkedSavingsGoal}</p>}
                                            <p className="text-xs text-gray-500">Ditambahkan oleh {item.userName || 'Anonim'} pada {item.createdAt && typeof item.createdAt.toDate === 'function' ? new Date(item.createdAt.toDate()).toLocaleDateString('id-ID') : 'Baru'}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </>
            );
        };
        
        // --- Komponen Diary (Diperbarui dengan Firestore) ---
        const Diary = ({ user, ledgerId, selectedDate, setFirestoreError }) => {
            const [diaryEntries, setDiaryEntries] = React.useState([]);
            const [newEntryText, setNewEntryText] = React.useState('');
            const [newTags, setNewTags] = React.useState(''); // New state for tags
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const monthYear = getMonthYear(selectedDate);

            React.useEffect(() => {
                if (!user || !ledgerId || !db) {
                    setIsLoading(false);
                    setDiaryEntries([]);
                    return;
                }
                setIsLoading(true);
                const collectionPath = `ledgers/${ledgerId}/diaryEntries`;
                // Query for entries in the selected month and year
                const q = query(collection(db, collectionPath), where('monthYear', '==', monthYear));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => {
                            // Safely access toDate()
                        const dateA = a.createdAt && typeof a.createdAt.toDate === 'function' ? a.createdAt.toDate() : new Date(0); // Default to epoch if invalid
                        const dateB = b.createdAt && typeof b.createdAt.toDate === 'function' ? b.createdAt.toDate() : new Date(0); // Default to epoch if invalid
                        return dateB - dateA;
                    });
                    setDiaryEntries(entries);
                    setIsLoading(false);
                }, (err) => {
                    console.error("Firestore Error:", err);
                    if (err.code === 'permission-denied') {
                        setFirestoreError("Kesalahan Izin: Gagal memuat entri buku harian. Pastikan Aturan Keamanan Firestore Anda mengizinkan akses untuk ledger ini. Silakan periksa Firebase Console Anda.");
                    }
                    setError("Gagal memuat entri buku harian.");
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [user, ledgerId, monthYear, setFirestoreError]);

            const addDiaryEntry = async (e) => {
                e.preventDefault();
                if (!newEntryText.trim() || !user || !user.uid || !ledgerId || !db) {
                    setError("Entri tidak boleh kosong atau informasi pengguna tidak lengkap.");
                    return;
                }
                try {
                    const entryData = {
                        text: newEntryText,
                        tags: newTags.split(',').map(tag => tag.trim()).filter(tag => tag !== ''), // Save tags as array
                        userId: user.uid,
                        userName: user.name || 'Anonim',
                        createdAt: serverTimestamp(),
                        monthYear: monthYear // Store month and year for filtering
                    };
                    await addDoc(collection(db, `ledgers/${ledgerId}/diaryEntries`), removeUndefined(entryData));
                    setNewEntryText('');
                    setNewTags(''); // Reset tags
                    setError('');
                } catch (err) {
                    console.error("Error adding diary entry:", err);
                    setError("Gagal menambah entri buku harian.");
                }
            };

            const deleteDiaryEntry = async (id) => {
                if (!db) return;
                try {
                    await deleteDoc(doc(db, `ledgers/${ledgerId}/diaryEntries/${id}`));
                } catch (err) {
                    console.error("Error deleting diary entry:", err);
                    setError("Gagal menghapus entri buku harian.");
                }
            };

            return (
                <>
                    <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Tulis Entri Buku Harian Baru</h2>
                        <form onSubmit={addDiaryEntry} className="space-y-4">
                            <textarea
                                value={newEntryText}
                                onChange={(e) => setNewEntryText(e.target.value)}
                                placeholder="Mulai menulis di sini..."
                                className="mt-4 w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500 transition duration-200 min-h-[120px]"
                                rows="6"
                                required
                            ></textarea>
                            <input
                                type="text"
                                value={newTags}
                                onChange={(e) => setNewTags(e.target.value)}
                                placeholder="Tags (pisahkan dengan koma, misal: senang, kerja, keluarga)"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-200"
                            />
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-white font-bold py-3 px-4 rounded-lg hover:from-yellow-600 hover:to-yellow-700 transition duration-300 flex items-center justify-center shadow-custom-yellow"
                            >
                                <PlusIcon /><span>Simpan Entri</span>
                            </button>
                        </form>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    </div>

                    <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 border border-gray-100">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Entri Buku Harian Anda - {selectedDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}</h2>
                        {isLoading ? <p className="text-center text-gray-500">Memuat entri...</p> : diaryEntries.length === 0 ? <div className="text-center text-gray-500 p-8">Belum ada entri buku harian bulan ini. Tulis entri pertama Anda di atas!</div> : (
                            <div className="space-y-4">
                                {diaryEntries.map(entry => (
                                    <div key={entry.id} className="bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-4">
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <p className="text-sm text-gray-500">
                                                    {entry.userName || 'Anonim'} pada {entry.createdAt && typeof entry.createdAt.toDate === 'function' ? new Date(entry.createdAt.toDate()).toLocaleDateString('id-ID') : 'Tidak Diketahui'}
                                                </p>
                                                {entry.tags && entry.tags.length > 0 && (
                                                    <div className="mt-1 flex flex-wrap gap-1">
                                                        {entry.tags.map((tag, index) => (
                                                            <span key={index} className="bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full">#{tag}</span>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                            <button onClick={() => deleteDiaryEntry(entry.id)} className="text-gray-400 hover:text-red-500 transition duration-200">
                                                <TrashIcon />
                                            </button>
                                        </div>
                                        <p className="text-gray-800 whitespace-pre-wrap">{entry.text}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </>
            );
        };

        // --- Komponen EventsCalendar (CoupleCalendar yang Diperbarui) ---
        const EventsCalendar = ({ user, ledgerId, selectedDate, requestNotificationPermission, setFirestoreError }) => {
            const [events, setEvents] = React.useState([]);
            const [newEventTitle, setNewEventTitle] = React.useState('');
            const [newEventDate, setNewEventDate] = React.useState(selectedDate.toISOString().split('T')[0]); // Default to current date
            const [newEventTime, setNewEventTime] = React.useState('');
            const [newEventDescription, setNewEventDescription] = React.useState('');
            const [newEventCategory, setNewEventCategory] = React.useState(''); // New state for event category
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const monthYear = getMonthYear(selectedDate);

            const daysInMonth = React.useMemo(() => new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0).getDate(), [selectedDate]);
            const firstDayOfMonth = React.useMemo(() => new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1).getDay(), [selectedDate]); // 0 for Sunday, 1 for Monday
            const calendarDays = React.useMemo(() => {
                const days = [];
                for (let i = 0; i < firstDayOfMonth; i++) {
                    days.push(null); // Placeholder for days before the 1st
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    days.push(i);
                }
                return days;
            }, [daysInMonth, firstDayOfMonth]);

            const dayNames = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab']; // Short day names

            // Example event categories
            const eventCategories = ['Ulang Tahun', 'Janji Temu', 'Liburan', 'Pekerjaan', 'Pribadi', 'Lain-lain'];

            // Effect untuk memuat acara dari Firestore
            React.useEffect(() => {
                if (!user || !ledgerId || !db) {
                    setIsLoading(false);
                    setEvents([]);
                    return;
                }
                setIsLoading(true);
                const collectionPath = `ledgers/${ledgerId}/events`;
                // Query untuk acara di bulan dan tahun yang dipilih
                const q = query(collection(db, collectionPath), where('monthYear', '==', monthYear));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => {
                        // Urutkan berdasarkan tanggal dan waktu
                        const dateA = a.date + ' ' + (a.time || '00:00');
                        const dateB = b.date + ' ' + (b.time || '00:00');
                        return new Date(dateA) - new Date(dateB);
                    });
                    setEvents(fetchedEvents);
                    setIsLoading(false);
                }, (err) => {
                    console.error("Firestore Error:", err);
                    if (err.code === 'permission-denied') {
                        setFirestoreError("Kesalahan Izin: Gagal memuat acara kalender. Pastikan Aturan Keamanan Firestore Anda mengizinkan akses untuk ledger ini. Silakan periksa Firebase Console Anda.");
                    }
                    setError("Gagal memuat acara.");
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [user, ledgerId, monthYear, setFirestoreError]);

            // Handler untuk menambahkan acara baru
            const addEvent = async (e) => {
                e.preventDefault();
                if (!newEventTitle.trim() || !newEventDate || !user || !user.uid || !ledgerId || !db) {
                    setError("Judul acara atau tanggal tidak boleh kosong.");
                    return;
                }
                try {
                    const eventData = {
                        title: newEventTitle,
                        date: newEventDate,
                        time: newEventTime || null,
                        description: newEventDescription || null,
                        category: newEventCategory || null, // Save event category
                        userId: user.uid,
                        userName: user.name || 'Anonim',
                        createdAt: serverTimestamp(),
                        monthYear: monthYear
                    };
                    await addDoc(collection(db, `ledgers/${ledgerId}/events`), removeUndefined(eventData));
                    setNewEventTitle('');
                    setNewEventDate(selectedDate.toISOString().split('T')[0]); // Reset to current selected date
                    setNewEventTime('');
                    setNewEventDescription('');
                    setNewEventCategory(''); // Reset category
                    setError('');

                    // Jadwalkan notifikasi jika waktu diatur dan izin diberikan
                    if (newEventTime) {
                        const [year, month, day] = newEventDate.split('-').map(Number);
                        const [hours, minutes] = newEventTime.split(':').map(Number);
                        const notificationTime = new Date(year, month - 1, day, hours, minutes, 0); // month - 1 karena bulan dimulai dari 0
                        const now = new Date();

                        if (notificationTime > now && Notification.permission === "granted") {
                            const delay = notificationTime.getTime() - now.getTime();
                            setTimeout(() => {
                                new Notification('Pengingat Acara', {
                                    body: `Waktunya untuk: ${newEventTitle} pada ${new Date(newEventDate).toLocaleDateString('id-ID')} jam ${newEventTime}!`,
                                    icon: 'https://placehold.co/40x40/E2E8F0/4A5568?text=🗓️' // Icon placeholder untuk acara
                                });
                            }, delay);
                            console.log(`Notifikasi acara dijadwalkan untuk: ${newEventTitle} pada ${notificationTime}`);
                        } else if (Notification.permission === "default") {
                            requestNotificationPermission(); // Minta izin jika belum diberikan
                        }
                    }

                } catch (err) {
                    console.error("Error adding event:", err);
                    setError("Gagal menambah acara.");
                }
            };

            // Handler untuk menghapus acara
            const deleteEvent = async (id) => {
                if (!db) return;
                try {
                    await deleteDoc(doc(db, `ledgers/${ledgerId}/events/${id}`));
                } catch (err) {
                    console.error("Error deleting event:", err);
                    setError("Gagal menghapus acara.");
                }
            };

            return (
                <>
                    <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Tambah Acara Baru</h2>
                        <form onSubmit={addEvent} className="space-y-4">
                            <input
                                type="text"
                                value={newEventTitle}
                                onChange={(e) => setNewEventTitle(e.target.value)}
                                placeholder="Judul Acara (misal: Kencan Malam)"
                                className="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                                required
                            />
                            <div className="flex space-x-2">
                                <input
                                    type="date"
                                    value={newEventDate}
                                    onChange={(e) => setNewEventDate(e.target.value)}
                                    className="w-1/2 p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                                    required
                                />
                                <input
                                    type="time"
                                    value={newEventTime}
                                    onChange={(e) => setNewEventTime(e.target.value)}
                                    className="w-1/2 p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                                />
                            </div>
                            <select value={newEventCategory} onChange={(e) => setNewEventCategory(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                                <option value="">Pilih Kategori</option>
                                {eventCategories.map(cat => (
                                    <option key={cat} value={cat}>{cat}</option>
                                ))}
                            </select>
                            <textarea
                                value={newEventDescription}
                                onChange={(e) => setNewEventDescription(e.target.value)}
                                placeholder="Deskripsi (opsional)"
                                className="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 min-h-[80px]"
                            ></textarea>
                            <button type="submit" className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:from-blue-600 hover:to-blue-700 transition duration-300 flex items-center justify-center shadow-custom-blue">
                                <PlusIcon /><span>Tambah Acara</span>
                            </button>
                        </form>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    </div>

                    <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Kalender - {selectedDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}</h2>
                        {isLoading ? <p className="text-center text-gray-500">Memuat acara...</p> : (
                            <div className="grid grid-cols-7 gap-1 text-center text-sm">
                                {dayNames.map(day => (
                                    <div key={day} className="font-bold text-gray-700 py-2">{day}</div>
                                ))}
                                {calendarDays.map((day, index) => {
                                    const dayEvents = day ? events.filter(event => {
                                        const eventDay = new Date(event.date).getDate();
                                        return eventDay === day;
                                    }) : [];
                                    const isToday = day && new Date().toDateString() === new Date(selectedDate.getFullYear(), selectedDate.getMonth(), day).toDateString();

                                    return (
                                        <div
                                            key={index}
                                            className={`p-1 h-20 border border-gray-200 rounded-md flex flex-col items-center overflow-hidden ${day ? 'bg-white' : 'bg-gray-50'} ${isToday ? 'border-blue-500 ring-2 ring-blue-300' : ''}`}
                                        >
                                            <span className={`font-semibold ${isToday ? 'text-blue-700' : 'text-gray-800'}`}>{day}</span>
                                            <div className="flex-grow overflow-y-auto w-full">
                                                {dayEvents.map(event => (
                                                    <div key={event.id} className={`text-xs truncate w-full px-1 py-0.5 rounded-sm mt-0.5
                                                        ${event.category === 'Ulang Tahun' ? 'bg-pink-100 text-pink-800' :
                                                        event.category === 'Janji Temu' ? 'bg-purple-100 text-purple-800' :
                                                        event.category === 'Liburan' ? 'bg-green-100 text-green-800' :
                                                        'bg-blue-100 text-blue-800'}`}>
                                                        {event.time && <span className="mr-1">{event.time}</span>}{event.title}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        <button
                            onClick={requestNotificationPermission}
                            className="mt-4 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-200"
                        >
                            Aktifkan Notifikasi
                        </button>
                    </div>
                </>
            );
        };


        // --- Komponen BudgetTracker (Baru) ---
        // Fungsionalitas BudgetTracker sekarang diintegrasikan ke FinanceTracker
        // Ini adalah komponen placeholder yang tidak lagi digunakan secara langsung sebagai tab terpisah
        const BudgetTracker = ({ user, ledgerId, selectedDate, setFirestoreError }) => {
            return (
                <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                    <h2 className="text-xl font-semibold text-gray-800 mb-4">Anggaran</h2>
                    <p className="text-gray-600">Fungsionalitas anggaran kini terintegrasi langsung di tab Keuangan. Anda dapat mengatur anggaran per kategori saat menambahkan transaksi pengeluaran.</p>
                </div>
            );
        };

        // --- Komponen ShoppingList (Baru) ---
        const ShoppingList = ({ user, ledgerId, setFirestoreError }) => {
            const [listItems, setListItems] = React.useState([]);
            const [newItemName, setNewItemName] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');

            React.useEffect(() => {
                if (!user || !ledgerId || !db) { setIsLoading(false); setListItems([]); return; }
                setIsLoading(true);
                const collectionPath = `ledgers/${ledgerId}/shoppingList`;
                const q = query(collection(db, collectionPath));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setListItems(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setIsLoading(false);
                }, (err) => {
                    console.error("Firestore Error:", err);
                    if (err.code === 'permission-denied') {
                        setFirestoreError("Kesalahan Izin: Gagal memuat daftar belanja. Pastikan Aturan Keamanan Firestore Anda mengizinkan akses untuk ledger ini. Silakan periksa Firebase Console Anda.");
                    }
                    setError("Gagal memuat daftar belanja.");
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [user, ledgerId, setFirestoreError]);

            const addListItem = async (e) => {
                e.preventDefault();
                if (!newItemName.trim() || !user || !ledgerId || !db) {
                    setError("Nama item tidak boleh kosong.");
                    return;
                }
                try {
                    await addDoc(collection(db, `ledgers/${ledgerId}/shoppingList`), {
                        name: newItemName,
                        purchased: false,
                        userId: user.uid,
                        userName: user.name || 'Anonim',
                        createdAt: serverTimestamp()
                    });
                    setNewItemName('');
                    setError('');
                } catch (err) {
                    console.error("Error adding list item:", err);
                    setError("Gagal menambah item.");
                }
            };

            const togglePurchasedStatus = async (item) => {
                if (!db) return;
                try {
                    await updateDoc(doc(db, `ledgers/${ledgerId}/shoppingList/${item.id}`), {
                        purchased: !item.purchased
                    });
                } catch (err) {
                    console.error("Error toggling purchased status:", err);
                    setError("Gagal memperbarui status item.");
                }
            };

            const deleteListItem = async (id) => {
                if (!db) return;
                try {
                    await deleteDoc(doc(db, `ledgers/${ledgerId}/shoppingList/${id}`));
                } catch (err) {
                    console.error("Error deleting list item:", err);
                    setError("Gagal menghapus item.");
                }
            };

            return (
                <>
                    <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Tambah Item Belanja</h2>
                        <form onSubmit={addListItem} className="space-y-3">
                            <input
                                type="text"
                                value={newItemName}
                                onChange={(e) => setNewItemName(e.target.value)}
                                placeholder="Nama Item (misal: Susu, Roti)"
                                className="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                                required
                            />
                            <button type="submit" className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:from-blue-600 hover:to-blue-700 transition duration-300 flex items-center justify-center shadow-custom-blue">
                                <PlusIcon /><span>Tambah Item</span>
                            </button>
                        </form>
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    </div>

                    <div className="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Daftar Belanja Anda</h2>
                        {isLoading ? <p className="text-center text-gray-500">Memuat daftar...</p> : listItems.length === 0 ? <div className="text-center text-gray-500 p-8">Daftar belanja Anda kosong. Tambahkan item pertama Anda di atas!</div> : (
                            <div className="space-y-3">
                                {listItems.map(item => (
                                    <div key={item.id} className="bg-gray-50 rounded-xl shadow-sm border border-gray-200 p-4 flex items-center justify-between">
                                        <div className="flex items-center">
                                            <input
                                                type="checkbox"
                                                checked={item.purchased || false}
                                                onChange={() => togglePurchasedStatus(item)}
                                                className="h-5 w-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer mr-3"
                                                title={item.purchased ? "Sudah Dibeli" : "Tandai Sudah Dibeli"}
                                            />
                                            <p className={`font-semibold text-gray-800 ${item.purchased ? 'line-through text-gray-500' : ''}`}>{item.name}</p>
                                        </div>
                                        <button onClick={() => deleteListItem(item.id)} className="text-gray-400 hover:text-red-500 p-2 rounded-full transition duration-200">
                                            <TrashIcon />
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </>
            );
        };


        // --- Komponen ProfileSetup ---
        const ProfileSetup = ({ onProfileSubmit, user }) => {
            const [name, setName] = React.useState(user?.name || '');
            const [photo, setPhoto] = React.useState(null); // This will hold the base64 data URL
            const [photoPreview, setPhotoPreview] = React.useState(user?.photoURL || 'https://placehold.co/100x100/E2E8F0/4A5568?text=?');
            const fileInputRef = React.useRef();

            React.useEffect(() => {
                // Update photoPreview if user's photoURL changes externally (e.g., from ledgerDoc)
                if (user?.photoURL && user.photoURL !== photoPreview) {
                    setPhotoPreview(user.photoURL);
                }
                // Update name if user's name changes externally
                if (user?.name && user.name !== name) {
                    setName(user.name);
                }
            }, [user]);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setPhoto(reader.result); // Set the base64 string
                        setPhotoPreview(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg text-center"> {/* Increased max-width */}
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">Pengaturan Profil</h2>

                        {/* Simplified profile header */}
                        <div className="flex flex-col items-center mb-8">
                            <div className="relative w-32 h-32 mb-4"> {/* Larger profile picture */}
                                <img src={photoPreview} alt="Profile" className="w-full h-full rounded-full object-cover border-4 border-blue-300 shadow-md" />
                                <button
                                    type="button"
                                    onClick={() => fileInputRef.current.click()}
                                    className="absolute bottom-0 right-0 bg-blue-600 p-2 rounded-full hover:bg-blue-700 transition duration-200"
                                    aria-label="Ubah Foto Profil"
                                >
                                    <CameraIcon />
                                </button>
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
                            </div>
                            {/* Tampilkan nama pengguna */}
                            <p className="text-xl font-semibold text-gray-800">{user?.name || 'Nama Pengguna'}</p>
                        </div>

                        <form onSubmit={(e) => { e.preventDefault(); onProfileSubmit(name, photo); }} className="space-y-4">
                            <label htmlFor="profile-name" className="sr-only">Nama Anda</label>
                            <input
                                id="profile-name"
                                type="text"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="Masukkan nama Anda"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            />
                            <button
                                type="submit"
                                className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200"
                            >
                                Simpan Profil
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Komponen MonthSelector ---
        const MonthSelector = ({ selectedDate, setSelectedDate }) => {
            const changeMonth = (offset) => {
                const newDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + offset, 1);
                setSelectedDate(newDate);
                console.log("Month changed to:", newDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' })); // Log perubahan bulan
            };

            return (
                <div className="flex items-center justify-center bg-white/50 backdrop-blur-sm p-0.5 rounded-lg sm:p-2">
                    <button onClick={() => changeMonth(-1)} className="px-1.5 py-0.5 rounded-md hover:bg-gray-200 transition duration-200 text-xs">‹</button>
                    <span className="font-semibold w-20 text-center text-gray-800 text-xs">{selectedDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}</span>
                    <button onClick={() => changeMonth(1)} className="px-1.5 py-0.5 rounded-md hover:bg-gray-200 transition duration-200 text-xs">›</button>
                </div>
            );
        };

        // --- Komponen PopupMenu (Baru) ---
        const PopupMenu = ({ activeTab, setActiveTab, onClose }) => {
            const handleTabClick = (tabName) => {
                setActiveTab(tabName);
                onClose(); // Close the popup after selecting a tab
            };

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-end justify-center z-40 p-4">
                    <div className="bg-white rounded-t-2xl shadow-lg w-full max-w-md p-6 animate-slideUp">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-gray-800">Menu Navigasi</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                                <CloseIcon />
                            </button>
                        </div>
                        <nav className="grid grid-cols-3 gap-4">
                            <button onClick={() => handleTabClick('dashboard')} className={`flex flex-col items-center justify-center p-2 rounded-lg transition duration-200 ${activeTab === 'dashboard' ? 'bg-indigo-100 text-indigo-600 shadow-sm' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'}`}>
                                <HomeIcon className="h-6 w-6 mb-1" />
                                <span className="text-xs font-medium">Beranda</span>
                            </button>
                            <button onClick={() => handleTabClick('finance')} className={`flex flex-col items-center justify-center p-2 rounded-lg transition duration-200 ${activeTab === 'finance' ? 'bg-blue-100 text-blue-600 shadow-sm' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'}`}>
                                <WalletIcon className="h-6 w-6 mb-1" />
                                <span className="text-xs font-medium">Keuangan</span>
                            </button>
                            <button onClick={() => handleTabClick('budget')} className={`flex flex-col items-center justify-center p-2 rounded-lg transition duration-200 ${activeTab === 'budget' ? 'bg-blue-100 text-blue-600 shadow-sm' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'}`}>
                                <ChartPieIcon className="h-6 w-6 mb-1" />
                                <span className="text-xs font-medium">Anggaran</span>
                            </button>
                            <button onClick={() => handleTabClick('savings')} className={`flex flex-col items-center justify-center p-2 rounded-lg transition duration-200 ${activeTab === 'savings' ? 'bg-green-100 text-green-600 shadow-sm' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'}`}>
                                <GiftIcon className="h-6 w-6 mb-1" />
                                <span className="text-xs font-medium">Tabungan</span>
                            </button>
                            <button onClick={() => handleTabClick('habits')} className={`flex flex-col items-center justify-center p-2 rounded-lg transition duration-200 ${activeTab === 'habits' ? 'bg-purple-100 text-purple-600 shadow-sm' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'}`}>
                                <CheckSquareIcon className="h-6 w-6 mb-1" />
                                <span className="text-xs font-medium">Kebiasaan</span>
                            </button>
                            <button onClick={() => handleTabClick('calendar')} className={`flex flex-col items-center justify-center p-2 rounded-lg transition duration-200 ${activeTab === 'calendar' ? 'bg-blue-100 text-blue-600 shadow-sm' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'}`}>
                                <CalendarIcon className="h-6 w-6 mb-1" />
                                <span className="text-xs font-medium">Kalender</span>
                            </button>
                            <button onClick={() => handleTabClick('wishlist')} className={`flex flex-col items-center justify-center p-2 rounded-lg transition duration-200 ${activeTab === 'wishlist' ? 'bg-red-100 text-red-600 shadow-sm' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'}`}>
                                <MapPinIcon className="h-6 w-6 mb-1" />
                                <span className="text-xs font-medium">Wishlist</span>
                            </button>
                            <button onClick={() => handleTabClick('diary')} className={`flex flex-col items-center justify-center p-2 rounded-lg transition duration-200 ${activeTab === 'diary' ? 'bg-yellow-100 text-yellow-600 shadow-sm' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'}`}>
                                <BookOpenIcon className="h-6 w-6 mb-1" />
                                <span className="text-xs font-medium">Diary</span>
                            </button>
                            <button onClick={() => handleTabClick('shopping')} className={`flex flex-col items-center justify-center p-2 rounded-lg transition duration-200 ${activeTab === 'shopping' ? 'bg-green-100 text-green-600 shadow-sm' : 'bg-gray-50 text-gray-700 hover:bg-gray-100'}`}>
                                <ShoppingCartIcon className="h-6 w-6 mb-1" />
                                <span className="text-xs font-medium">Belanja</span>
                            </button>
                        </nav>
                    </div>
                </div>
            );
        };


        // --- Komponen Utama Aplikasi ---
        function App() {
            const isConfigValid = firebaseConfig.apiKey && !firebaseConfig.apiKey.startsWith("GANTI_DENGAN");

            const [user, setUser] = React.useState(null);
            const [ledgerId, setLedgerId] = React.useState(localStorage.getItem('ledgerId') || '');
            const [tempLedgerId, setTempLedgerId] = React.useState('');
            const [copied, setCopied] = React.useState(false);
            const [activeTab, setActiveTab] = React.useState('dashboard');
            const [showProfileSetup, setShowProfileSetup] = React.useState(false);
            const [ledgerDoc, setLedgerDoc] = React.useState(null);
            const [selectedDate, setSelectedDate] = React.useState(new Date());
            const [authError, setAuthError] = React.useState(null);
            const [isAuthReady, setIsAuthReady] = React.useState(false); // State baru untuk melacak kesiapan otentikasi
            const [showMenuPopup, setShowMenuPopup] = React.useState(false); // State baru untuk menu popup
            const [firestoreError, setFirestoreError] = React.useState(null); // State baru untuk error Firestore

            // Log selectedDate di App setiap kali berubah
            React.useEffect(() => {
                console.log("App selectedDate updated:", selectedDate.toLocaleString('id-ID', { month: 'long', year: 'numeric', day: 'numeric' }));
            }, [selectedDate]);

            // Fungsi untuk meminta izin notifikasi browser
            const requestNotificationPermission = () => {
                if (!("Notification" in window)) {
                    console.log("Browser ini tidak mendukung notifikasi desktop.");
                } else if (Notification.permission === "default") {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            console.log("Izin notifikasi diberikan.");
                        } else {
                            console.log("Izin notifikasi ditolak. Anda tidak akan menerima pengingat.");
                        }
                    });
                }
            };

            // Fungsi untuk registrasi
            const handleRegister = async (email, password) => {
                try {
                    // Set persistence before creating user
                    await setPersistence(authInstance, browserLocalPersistence);
                    await createUserWithEmailAndPassword(authInstance, email, password);
                    setAuthError(null); // Reset error
                    requestNotificationPermission(); // Request permission after successful registration
                } catch (error) {
                    console.error("Registration error:", error);
                    setAuthError(error);
                    throw error; // Throw error so AuthScreen can display it
                }
            };

            // Fungsi untuk login
            const handleLogin = async (email, password) => {
                try {
                    // Set persistence before signing in
                    await setPersistence(authInstance, browserLocalPersistence);
                    await signInWithEmailAndPassword(authInstance, email, password);
                    setAuthError(null); // Reset error
                    requestNotificationPermission(); // Request permission after successful login
                } catch (error) {
                    console.error("Login error:", error);
                    setAuthError(error);
                    throw error; // Throw error so AuthScreen can display it
                }
            };

            // Fungsi untuk logout
            const handleLogout = async () => {
                try {
                    await signOut(authInstance);
                    setUser(null);
                    setLedgerId('');
                    localStorage.removeItem('ledgerId');
                    setActiveTab('dashboard');
                    setShowProfileSetup(false);
                    setFirestoreError(null); // Clear Firestore error on logout
                } catch (error) {
                    console.error("Logout error:", error);
                }
            };

            const handleProfileSubmit = async (name, photoURL) => {
                if (!user?.uid || !ledgerId || !name || !db) {
                    console.error("Informasi profil tidak lengkap.");
                    return;
                }
                const ledgerDocRef = doc(db, `ledgers/${ledgerId}`);
                try {
                    // Get current participant data, ensure it's an object
                    const currentParticipantData = ledgerDoc?.participants?.[user.uid] || {};

                    // Build newParticipantData object, ensuring no undefined values
                    const newParticipantData = {
                        name: name || null, // Ensure name is always string or null
                        photoURL: photoURL || currentParticipantData.photoURL || null, // Ensure photoURL is always string or null
                        email: user.email || null // Ensure email is always string or null
                    };

                    // Recursively remove undefined properties before saving to Firestore
                    // This is the last safety layer
                    const sanitizedParticipantData = removeUndefined(newParticipantData);

                    // Debugging: Log data before saving
                    console.log("Data to be saved to Firestore:", sanitizedParticipantData);

                    await setDoc(ledgerDocRef, {
                        participants: { [user.uid]: sanitizedParticipantData }
                    }, { merge: true });

                    // Update user state in App with the new name and photoURL
                    setUser(prev => ({ ...prev, ...sanitizedParticipantData }));
                    setShowProfileSetup(false);
                    setFirestoreError(null); // Clear Firestore error after successful profile update
                } catch (error) {
                    console.error("Error setting profile:", error);
                    if (error.code === 'permission-denied') {
                        setFirestoreError("Kesalahan Izin: Gagal memperbarui profil. Pastikan Aturan Keamanan Firestore Anda mengizinkan akses untuk ledger ini. Silakan periksa Firebase Console Anda.");
                    }
                }
            };

            // FIX: Move the definitions of these functions here
            const createNewLedger = () => {
                const newId = `BERSAMA-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
                setLedgerId(newId);
                localStorage.setItem('ledgerId', newId);
            };
            const joinLedger = () => {
                if (tempLedgerId) {
                    setLedgerId(tempLedgerId);
                    localStorage.setItem('ledgerId', tempLedgerId);
                }
            };
            const copyLedgerId = () => {
                const d = document.createElement('textarea');
                d.value = ledgerId;
                document.body.appendChild(d);
                d.select();
                document.execCommand('copy');
                document.body.removeChild(d);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };


            // Effect for Firebase authentication
            React.useEffect(() => {
                if (!authInstance) return;

                const unsubscribe = onAuthStateChanged(authInstance, async (currentUser) => {
                    if (currentUser) {
                        // Ensure properties are set to null if undefined from currentUser
                        setUser({
                            uid: currentUser.uid,
                            email: currentUser.email || null,
                            name: currentUser.displayName || null, // displayName can be undefined
                            photoURL: currentUser.photoURL || null // photoURL can be undefined
                        });
                        setIsAuthReady(true); // Authentication is ready
                    } else {
                        // If no user is logged in, we no longer automatically sign-in anonymously here
                        // User will be directed to AuthScreen
                        setUser(null);
                        setIsAuthReady(true); // Still set to true so AuthScreen can be displayed
                    }
                });
                return () => unsubscribe();
            }, [authInstance]);

            // Effect to load ledger data and user profile
            React.useEffect(() => {
                // Only run if user is authenticated and db exists
                if (!user?.uid || !ledgerId || !db) {
                    setLedgerDoc(null); // Reset ledgerDoc if no user/ledgerId
                    return;
                }

                const ledgerDocRef = doc(db, `ledgers/${ledgerId}`);
                const unsub = onSnapshot(ledgerDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setLedgerDoc(data);
                        const participants = data.participants || {};
                        // Update user state with profile data from ledger
                        if (participants[user.uid]) {
                            // Ensure properties are set to null if undefined from Firestore
                            setUser(prev => ({
                                ...prev,
                                name: participants[user.uid].name || null,
                                photoURL: participants[user.uid].photoURL || null
                            }));
                            setShowProfileSetup(false);
                            setFirestoreError(null); // Clear Firestore error on successful ledger doc fetch
                        } else {
                            // If user is not yet in ledger participants, show profile setup
                            // Ensure name and photoURL properties in user state are null
                            setUser(prev => ({
                                ...prev,
                                name: null,
                                photoURL: null
                            }));
                            setShowProfileSetup(true);
                            // Set a specific error for profile setup if ledger exists but user is not a participant
                            setFirestoreError("Profil Anda belum terdaftar di ruang bersama ini. Silakan lengkapi profil Anda.");
                        }
                    } else {
                        // If ledger does not exist, maybe ID is wrong or newly created, ask user to create profile
                        setLedgerDoc(null);
                        setShowProfileSetup(true);
                        setFirestoreError("Ruang bersama tidak ditemukan atau Anda belum membuat/bergabung. Silakan buat ruang baru atau bergabung.");
                    }
                }, (error) => {
                    console.error("Error fetching ledger document:", error);
                    setLedgerDoc(null);
                    if (error.code === 'permission-denied') {
                        setFirestoreError("Kesalahan Izin: Gagal memuat ruang bersama. Pastikan Aturan Keamanan Firestore Anda mengizinkan akses untuk ledger ini. Silakan periksa Firebase Console Anda.");
                    } else {
                        setFirestoreError("Terjadi kesalahan saat memuat ruang bersama. Silakan coba lagi.");
                    }
                });
                return unsub;
            }, [user?.uid, ledgerId, db, setFirestoreError]);

            // Display based on application status
            if (!isConfigValid) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-red-50">
                        <div className="text-center p-8 bg-white rounded-lg shadow-2xl max-w-lg">
                            <h2 className="text-2xl font-bold text-red-700 mb-4">Konfigurasi Database Diperlukan</h2>
                            <p className="text-gray-700 mb-2">
                                Aplikasi ini belum terhubung ke database. Anda perlu menyalin "kunci" konfigurasi dari proyek Firebase Anda.
                            </p>
                            <p className="text-gray-700 mb-6">
                                Silakan buka file <code>index.html</code> di GitHub, cari variabel <code>firebaseConfig</code>, dan ganti isinya dengan kunci yang Anda dapatkan dari Firebase.
                            </p>
                            <a href="https://console.firebase.google.com" target="_blank" rel="noopener noreferrer" className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                                Buka Firebase Console
                            </a>
                        </div>
                    </div>
                );
            }

            // Waiting for authentication to be ready before displaying auth screen or app
            if (!isAuthReady) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
                        <p className="text-gray-600 text-lg">Memuat otentikasi...</p>
                    </div>
                );
            }

            // If no user is logged in, display AuthScreen
            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
                        <AuthScreen onLogin={handleLogin} onRegister={handleRegister} authError={authError} />
                    </div>
                );
            }

            // If user is logged in but hasn't selected/created a ledger
            if (!ledgerId) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
                        <div className="w-full max-w-md bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-8 text-center">
                            <h1 className="text-2xl font-bold mb-2">Dompet & Target Bersama</h1>
                            <p className="text-gray-600 mb-8">Atur keuangan, tabungan, dan kebiasaan bersama pasangan.</p>
                            <div className="space-y-4">
                                <button onClick={createNewLedger} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-200">Buat Ruang Baru</button>
                                <div className="flex items-center space-x-2">
                                    <input type="text" value={tempLedgerId} onChange={(e) => setTempLedgerId(e.target.value)} placeholder="Masukkan Kode Ruang" className="flex-grow p-3 border rounded-lg" />
                                    <button onClick={joinLedger} disabled={!tempLedgerId} className="bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 disabled:bg-gray-300 transition duration-200">Gabung</button>
                                </div>
                            </div>
                            <button onClick={handleLogout} className="mt-8 text-red-500 hover:underline text-sm">Logout</button>
                        </div>
                    </div>
                );
            }

            // If user is logged in and ledgerId exists, display the main application
            return (
                <div className="min-h-screen font-sans bg-gradient-to-br from-blue-50 to-indigo-100 pb-16"> {/* Add padding-bottom for fixed footer */}
                    {showProfileSetup && <ProfileSetup onProfileSubmit={handleProfileSubmit} user={user} />}
                    {firestoreError && <MessageBox message={firestoreError} onClose={() => setFirestoreError(null)} />}
                    <header className="bg-white/70 backdrop-blur-sm shadow-md sticky top-0 z-20">
                        <div className="max-w-4xl mx-auto p-1 sm:p-4"> {/* Reduced overall padding on mobile */}
                            {/* Reduced vertical padding on mobile and adjusted text size */}
                            <div className="flex flex-col sm:flex-row justify-between items-center py-0.5 sm:py-4"> {/* Further reduced py */}
                                <div className="flex items-center gap-0.5 sm:gap-3 mb-1 sm:mb-0"> {/* Further reduced gap and mb */}
                                    {/* Using public placeholder URL for logo in header */}
                                    <img
                                        src="https://placehold.co/40x40/E2E8F0/4A5568?text=Logo"
                                        alt="Logo Dompet Bersama"
                                        className="h-5 w-auto sm:h-10" /* Reduced logo height on mobile */
                                        onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/40x40/E2E8F0/4A5568?text=Error'; }} /* Fallback if image fails to load */
                                    />
                                    <h1 className="text-sm font-bold text-blue-600 sm:text-xl">Ruang Bersama</h1> {/* Reduced text size on mobile */}
                                </div>
                                {/* Reduced MonthSelector size on mobile */}
                                <MonthSelector selectedDate={selectedDate} setSelectedDate={setSelectedDate} /> {/* Ensure MonthSelector receives prop */}
                                <button onClick={handleLogout} className="text-xs text-red-500 hover:underline mt-0.5 sm:mt-0">Logout</button>
                            </div>
                            <div className="flex justify-center items-center mt-0.5">
                                <button onClick={copyLedgerId} className="flex items-center space-x-0.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-mono py-0.5 px-1.5 rounded-full">
                                    <span>Kode: {ledgerId}</span>
                                    {copied ? <span className="text-green-500 ml-0.5">Tersalin!</span> : <CopyIcon className="h-3 w-3" />}
                                </button>
                            </div>
                        </div>
                    </header>
                    <main className="max-w-4xl mx-auto p-4">
                        {activeTab === 'dashboard' && <Dashboard user={user} ledgerId={ledgerId} setActiveTab={setActiveTab} ledgerDoc={ledgerDoc} selectedDate={selectedDate} setFirestoreError={setFirestoreError} />}
                        {activeTab === 'finance' && <FinanceTracker user={user} ledgerId={ledgerId} selectedDate={selectedDate} setFirestoreError={setFirestoreError} />}
                        {activeTab === 'budget' && <BudgetTracker user={user} ledgerId={ledgerId} selectedDate={selectedDate} setFirestoreError={setFirestoreError} />}
                        {activeTab === 'savings' && <SavingsTracker user={user} ledgerId={ledgerId} setFirestoreError={setFirestoreError} />}
                        {activeTab === 'habits' && <HabitTracker user={user} ledgerId={ledgerId} selectedDate={selectedDate} requestNotificationPermission={requestNotificationPermission} setFirestoreError={setFirestoreError} />}
                        {activeTab === 'calendar' && <EventsCalendar user={user} ledgerId={ledgerId} selectedDate={selectedDate} requestNotificationPermission={requestNotificationPermission} setFirestoreError={setFirestoreError} />}
                        {activeTab === 'wishlist' && <TravelWishlist user={user} ledgerId={ledgerId} setFirestoreError={setFirestoreError} />}
                        {activeTab === 'diary' && <Diary user={user} ledgerId={ledgerId} selectedDate={selectedDate} setFirestoreError={setFirestoreError} />}
                        {activeTab === 'shopping' && <ShoppingList user={user} ledgerId={ledgerId} setFirestoreError={setFirestoreError} />}
                    </main>

                    {/* Footer Navigation (now a single menu button) */}
                    <footer className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-30">
                        <div className="flex justify-center items-center h-10 sm:h-16 max-w-xl mx-auto">
                            <button
                                onClick={() => setShowMenuPopup(true)}
                                className="flex flex-col items-center justify-center p-2 text-xs font-medium text-gray-700 hover:text-blue-600 transition duration-200"
                            >
                                <MenuIcon className="h-6 w-6 mb-1" />
                                <span>Menu</span>
                            </button>
                        </div>
                    </footer>

                    {/* Popup Menu */}
                    {showMenuPopup && (
                        <PopupMenu
                            activeTab={activeTab}
                            setActiveTab={setActiveTab}
                            onClose={() => setShowMenuPopup(false)}
                        />
                    )}
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

        // --- Pendaftaran Service Worker untuk PWA ---
        // Pastikan service-worker.js berada di root direktori Anda
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>

    <script id="service-worker-script" type="javascript/plain">
        // service-worker.js content
        const CACHE_NAME = 'dompet-bersama-cache-v1';
        const urlsToCache = [
            '/',
            '/index.html',
            // Tambahkan aset-aset penting lainnya yang ingin di-cache
            // Misalnya: CSS, JavaScript, gambar statis, dll.
            // Perhatikan bahwa CDN eksternal mungkin tidak bisa di-cache dengan strategi ini
            'https://cdn.tailwindcss.com',
            'https://unpkg.com/react@18/umd/react.development.js',
            'https://unpkg.com/react-dom@18/umd/react-dom.development.js',
            'https://unpkg.com/recharts/umd/Recharts.min.js',
            'https://unpkg.com/@babel/standalone/babel.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
            // Placeholder image for logo
            'https://placehold.co/40x40/E2E8F0/4A5568?text=Logo',
            'https://placehold.co/40x40/E2E8F0/4A5568?text=⏰', // Habit icon
            'https://placehold.co/40x40/E2E8F0/4A5568?text=🗓️', // Calendar icon
            'https://placehold.co/40x40/E2E8F0/4A5568?text=Error', // Error fallback
            'https://placehold.co/100x100/E2E8F0/4A5568?text=?' // Profile placeholder
        ];

        self.addEventListener('install', event => {
            event.waitUntil(
                caches.open(CACHE_NAME)
                    .then(cache => {
                        console.log('Opened cache');
                        return cache.addAll(urlsToCache);
                    })
            );
        });

        self.addEventListener('fetch', event => {
            event.respondWith(
                caches.match(event.request)
                    .then(response => {
                        // Cache hit - return response
                        if (response) {
                            return response;
                        }
                        // If not in cache, fetch from network
                        return fetch(event.request).then(
                            function(response) {
                                // Check if we received a valid response
                                if(!response || response.status !== 200 || response.type !== 'basic') {
                                    return response;
                                }

                                // IMPORTANT: Clone the response. A response is a stream
                                // and can only be consumed once. We must clone the response
                                // so that we can send one to the browser and one to the cache.
                                var responseToCache = response.clone();

                                caches.open(CACHE_NAME)
                                    .then(function(cache) {
                                        cache.put(event.request, responseToCache);
                                    });

                                return response;
                            }
                        );
                    })
            );
        });

        self.addEventListener('activate', event => {
            const cacheWhitelist = [CACHE_NAME];
            event.waitUntil(
                caches.keys().then(cacheNames => {
                    return Promise.all(
                        cacheNames.map(cacheName => {
                            if (cacheWhitelist.indexOf(cacheName) === -1) {
                                return caches.delete(cacheName);
                            }
                        })
                    );
                })
            );
        });
    </script>
</body>
</html>
