<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dompet & Target Bersama</title>
    <!--
      OPSIONAL: Jika Anda melanjutkan verifikasi Google, 
      tempel kode verifikasi Anda di sini.
    -->
    <meta name="google-site-verification" content="9b5idOC6Ce2_GFZmJStbYbVjZ1qelnaRPCkxhu9qpxM" />

    <!-- Memuat Library -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- Memuat Firebase SDK ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, where, serverTimestamp, updateDoc, arrayUnion, arrayRemove, increment, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        
        // --- Konfigurasi Firebase ---
        // Kunci database Anda sudah dimasukkan di sini.
        const firebaseConfig = {
           apiKey: "AIzaSyB91qA6AGjNBAEyIQSlHvN482esZKlP_Ok",
           authDomain: "dompet-pasangan-kita.firebaseapp.com",
           projectId: "dompet-pasangan-kita",
           storageBucket: "dompet-pasangan-kita.appspot.com",
           messagingSenderId: "54318864599",
           appId: "1:54318864599:web:3fc852b439a62577563892"
        };
        
        const isConfigValid = firebaseConfig.apiKey && !firebaseConfig.apiKey.startsWith("GANTI_DENGAN");

        // --- Inisialisasi Firebase ---
        let app, db, authInstance;
        if (isConfigValid) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                authInstance = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        }

        // --- Komponen Ikon ---
        const PlusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>;
        const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const CopyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>;
        const TargetIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path strokeLinecap="round" strokeLinejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const MoneyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>;
        const PiggyBankIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" /></svg>;
        const HomeIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>;
        const CameraIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clipRule="evenodd" /></svg>;

        const formatCurrency = (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value);
        const getMonthYear = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        // --- Komponen Dashboard ---
        const Dashboard = ({ user, ledgerId, setActiveTab, ledgerDoc, selectedDate }) => {
            const { PieChart, Pie, Cell, Tooltip, ResponsiveContainer, Legend } = window.Recharts || {};
            const [transactions, setTransactions] = React.useState([]);
            const [goals, setGoals] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);

            const monthYear = getMonthYear(selectedDate);

            React.useEffect(() => {
                if (!user || !ledgerId || !db) { setIsLoading(false); return; }
                setIsLoading(true);
                const transQuery = query(collection(db, `ledgers/${ledgerId}/transactions`), where('monthYear', '==', monthYear));
                const goalsQuery = query(collection(db, `ledgers/${ledgerId}/savings`));

                const unsubTransactions = onSnapshot(transQuery, (snapshot) => setTransactions(snapshot.docs.map(doc => doc.data())));
                const unsubGoals = onSnapshot(goalsQuery, (snapshot) => setGoals(snapshot.docs.map(doc => doc.data())));
                
                setIsLoading(false);
                return () => { unsubTransactions(); unsubGoals(); };
            }, [user, ledgerId, monthYear]);

            const { totalIncome, totalExpense, balance } = React.useMemo(() => {
                const income = transactions.filter(t => t.type === 'pemasukan').reduce((sum, t) => sum + Number(t.amount), 0);
                const expense = transactions.filter(t => t.type === 'pengeluaran').reduce((sum, t) => sum + Number(t.amount), 0);
                return { totalIncome: income, totalExpense: expense, balance: income - expense };
            }, [transactions]);
            
            const { totalSaved, activeGoals } = React.useMemo(() => {
                const saved = goals.reduce((sum, g) => sum + Number(g.currentAmount), 0);
                return { totalSaved: saved, activeGoals: goals.length };
            }, [goals]);

            const expenseChartData = React.useMemo(() => {
                const expensesByUser = transactions
                    .filter(t => t.type === 'pengeluaran')
                    .reduce((acc, t) => {
                        const name = t.userName || 'Lainnya';
                        if (!acc[name]) acc[name] = 0;
                        acc[name] += Number(t.amount);
                        return acc;
                    }, {});

                return Object.keys(expensesByUser).map(name => ({ name, value: expensesByUser[name] }));
            }, [transactions]);

            const partner = React.useMemo(() => {
                if (!ledgerDoc || !ledgerDoc.participants || !user) return null;
                const partnerUid = Object.keys(ledgerDoc.participants).find(uid => uid !== user.uid);
                if (!partnerUid) return null;
                return { uid: partnerUid, ...ledgerDoc.participants[partnerUid] };
            }, [ledgerDoc, user]);

            const COLORS = ['#3B82F6', '#EF4444', '#F97316', '#8B5CF6'];
            
            if (isLoading) return <p className="text-center text-gray-500 mt-8">Memuat Dashboard...</p>;

            return (
                <div className="space-y-6">
                     <div className="bg-white/70 backdrop-blur-sm p-6 rounded-2xl shadow-lg flex justify-between items-center">
                        <div>
                            <h2 className="text-xl font-bold text-gray-800">Selamat Datang, {user.name || 'Pengguna'}!</h2>
                            <p className="text-gray-600">Ini ringkasan untuk bulan {selectedDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}.</p>
                        </div>
                        {partner && (
                            <div className="text-right">
                                <p className="text-sm text-gray-500">Pasangan Anda</p>
                                <div className="flex items-center gap-2">
                                    <span className="font-semibold">{partner.name}</span>
                                    <img src={partner.photoURL || 'https://placehold.co/40x40/E2E8F0/4A5568?text=?'} alt={partner.name} className="w-10 h-10 rounded-full object-cover" />
                                </div>
                            </div>
                        )}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white/70 backdrop-blur-sm p-6 rounded-2xl shadow-lg flex flex-col justify-center items-center"><p className="text-sm text-gray-500">Total Saldo Bulan Ini</p><p className={`text-4xl font-bold ${balance >= 0 ? 'text-gray-800' : 'text-red-600'}`}>{formatCurrency(balance)}</p></div>
                        <div className="bg-green-100/70 backdrop-blur-sm p-6 rounded-2xl shadow-lg flex flex-col justify-center items-center"><p className="text-sm text-green-700">Pemasukan Bulan Ini</p><p className="text-2xl font-bold text-green-800">{formatCurrency(totalIncome)}</p></div>
                        <div className="bg-red-100/70 backdrop-blur-sm p-6 rounded-2xl shadow-lg flex flex-col justify-center items-center"><p className="text-sm text-red-700">Pengeluaran Bulan Ini</p><p className="text-2xl font-bold text-red-800">{formatCurrency(totalExpense)}</p></div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div className="lg:col-span-2 bg-white/70 backdrop-blur-sm p-6 rounded-2xl shadow-lg"><h3 className="font-bold text-lg text-gray-800 mb-4">Distribusi Pengeluaran</h3>{PieChart && expenseChartData.length > 0 ? (<div className="h-60"><ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={expenseChartData} cx="50%" cy="50%" innerRadius={50} outerRadius={70} fill="#8884d8" paddingAngle={5} dataKey="value" label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}><Tooltip formatter={(value) => formatCurrency(value)} />{expenseChartData.map((entry, index) => (<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />))}</Pie></PieChart></ResponsiveContainer></div>) : <p className="text-center text-gray-400 pt-16">Belum ada data pengeluaran.</p>}</div>
                        <div className="lg:col-span-3 bg-white/70 backdrop-blur-sm p-6 rounded-2xl shadow-lg"><h3 className="font-bold text-lg text-gray-800 mb-4">Progres Tabungan (Total)</h3><div className="space-y-4"><div className="flex justify-around text-center"><div><p className="text-sm text-gray-500">Total Dana Terkumpul</p><p className="text-2xl font-bold text-green-600">{formatCurrency(totalSaved)}</p></div><div><p className="text-sm text-gray-500">Target Aktif</p><p className="text-2xl font-bold text-blue-600">{activeGoals}</p></div></div>{goals.length > 0 ? (<div className="mt-4">{goals.slice(0, 2).map(g => { const progress = g.targetAmount > 0 ? (g.currentAmount / g.targetAmount) * 100 : 0; return (<div key={g.id} className="mb-3"><div className="flex justify-between text-sm font-medium"><p>{g.name}</p><p>{progress.toFixed(0)}%</p></div><div className="w-full bg-gray-200 rounded-full h-2.5 mt-1"><div className="bg-green-500 h-2.5 rounded-full" style={{ width: `${progress}%` }}></div></div></div>)})}</div>) : (<p className="text-center text-gray-400 mt-8">Belum ada target tabungan.</p>)}<button onClick={() => setActiveTab('savings')} className="w-full mt-4 bg-green-100 text-green-800 font-bold py-2 px-4 rounded-lg hover:bg-green-200">Lihat Semua Tabungan</button></div></div>
                    </div>
                </div>
            );
        };

        // --- Komponen Pelacak Keuangan ---
        const FinanceTracker = ({ user, ledgerId, selectedDate }) => {
            const [transactions, setTransactions] = React.useState([]);
            const [description, setDescription] = React.useState('');
            const [amount, setAmount] = React.useState('');
            const [type, setType] = React.useState('pengeluaran');
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const monthYear = getMonthYear(selectedDate);

            React.useEffect(() => {
                if (!user || !ledgerId || !db) { setIsLoading(false); setTransactions([]); return; }
                setIsLoading(true);
                const collectionPath = `ledgers/${ledgerId}/transactions`;
                const q = query(collection(db, collectionPath), where('monthYear', '==', monthYear));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const newTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                    setTransactions(newTransactions);
                    setIsLoading(false);
                }, (err) => { console.error("Firestore Error:", err); setError("Gagal memuat data transaksi."); setIsLoading(false); });
                return () => unsubscribe();
            }, [user, ledgerId, monthYear]);

            const addTransaction = async (e) => {
                e.preventDefault();
                if (!description || !amount || !user || !ledgerId || !db) return;
                try {
                    const collectionPath = `ledgers/${ledgerId}/transactions`;
                    await addDoc(collection(db, collectionPath), { description, amount: Number(amount), type, userId: user.uid, userName: user.name || 'Anonim', createdAt: serverTimestamp(), monthYear: monthYear });
                    setDescription(''); setAmount(''); setError('');
                } catch (err) { console.error("Error adding transaction:", err); setError("Gagal menambah transaksi."); }
            };

            const deleteTransaction = async (id) => {
                if(!db) return;
                try { await deleteDoc(doc(db, `ledgers/${ledgerId}/transactions/${id}`)); } catch (err) { console.error("Error deleting transaction:", err); setError("Gagal menghapus transaksi."); }
            };

            return (
                <><div className="bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6"><h2 className="text-lg font-semibold text-gray-800 mb-4">Tambah Transaksi Baru</h2><form onSubmit={addTransaction} className="space-y-4"><input type="text" value={description} onChange={(e) => setDescription(e.target.value)} placeholder="Contoh: Belanja bulanan" className="w-full p-3 border border-gray-300 rounded-lg" required /><input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="Jumlah (misal: 50000)" className="w-full p-3 border border-gray-300 rounded-lg" required /><div className="flex space-x-4"><label className={`flex-1 flex items-center justify-center p-3 border rounded-lg cursor-pointer ${type === 'pengeluaran' ? 'bg-blue-50 border-blue-500' : ''}`}><input type="radio" name="type" value="pengeluaran" checked={type === 'pengeluaran'} onChange={(e) => setType(e.target.value)} className="hidden" /><span>Pengeluaran</span></label><label className={`flex-1 flex items-center justify-center p-3 border rounded-lg cursor-pointer ${type === 'pemasukan' ? 'bg-blue-50 border-blue-500' : ''}`}><input type="radio" name="type" value="pemasukan" checked={type === 'pemasukan'} onChange={(e) => setType(e.target.value)} className="hidden" /><span>Pemasukan</span></label></div><button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center"><PlusIcon /><span>Tambah</span></button></form>{error && <p className="text-red-500 text-sm mt-2">{error}</p>}</div>
                <div><h2 className="text-lg font-semibold text-gray-800 mb-4">Riwayat Transaksi - {selectedDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}</h2>{isLoading ? <p className="text-center text-gray-500">Memuat data...</p> : transactions.length === 0 ? <div className="text-center bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-8"><p className="text-gray-500">Belum ada transaksi bulan ini.</p></div> : (<div className="space-y-3">{transactions.map(t => (<div key={t.id} className="bg-white/70 backdrop-blur-sm rounded-xl shadow-md p-4 flex items-center justify-between"><div><p className="font-semibold text-gray-800">{t.description}</p><p className="text-sm text-gray-500">{t.userName || 'Anonim'} - {t.createdAt ? new Date(t.createdAt.toDate()).toLocaleDateString('id-ID') : 'Baru'}</p></div><div className="flex items-center space-x-4"><p className={`font-bold ${t.type === 'pemasukan' ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(t.amount)}</p><button onClick={() => deleteTransaction(t.id)} className="text-gray-400 hover:text-red-500 p-2 rounded-full"><TrashIcon /></button></div></div>))}</div>)}</div></>
            );
        };

        // --- Komponen Pelacak Kebiasaan ---
        const HabitTracker = ({ user, ledgerId, selectedDate }) => {
            const [habits, setHabits] = React.useState([]);
            const [newHabitName, setNewHabitName] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const monthYear = getMonthYear(selectedDate);

            const daysInMonth = React.useMemo(() => new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0).getDate(), [selectedDate]);
            const daysArray = Array.from({ length: daysInMonth }, (_, i) => i + 1);

            React.useEffect(() => {
                if (!user || !ledgerId || !db) { setIsLoading(false); setHabits([]); return; }
                setIsLoading(true);
                const collectionPath = `ledgers/${ledgerId}/habits`;
                const q = query(collection(db, collectionPath));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setHabits(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setIsLoading(false);
                }, (err) => { console.error("Firestore Error:", err); setError("Gagal memuat data kebiasaan."); setIsLoading(false); });
                return () => unsubscribe();
            }, [user, ledgerId]);

            const addHabit = async (e) => {
                e.preventDefault();
                if (!newHabitName || !user || !ledgerId || !db) return;
                try {
                    const collectionPath = `ledgers/${ledgerId}/habits`;
                    await addDoc(collection(db, collectionPath), { name: newHabitName, completions: [], createdAt: serverTimestamp(), userId: user.uid });
                    setNewHabitName(''); setError('');
                } catch (err) { console.error("Error adding habit:", err); setError("Gagal menambah kebiasaan."); }
            };

            const toggleHabitCompletion = async (habit, day) => {
                if(!db) return;
                const dateString = `${monthYear}-${String(day).padStart(2, '0')}`;
                const currentCompletions = habit.completions || [];
                const isDone = currentCompletions.includes(dateString);
                const newCompletions = isDone ? arrayRemove(dateString) : arrayUnion(dateString);
                try { await updateDoc(doc(db, `ledgers/${ledgerId}/habits/${habit.id}`), { completions: newCompletions }); } catch (err) { console.error("Error toggling habit:", err); }
            };
            
            const deleteHabit = async (id) => {
                if(!db) return;
                try { await deleteDoc(doc(db, `ledgers/${ledgerId}/habits/${id}`)); } catch (err) { console.error("Error deleting habit:", err); }
            };

            return (
                <><div className="bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6"><h2 className="text-lg font-semibold text-gray-800 mb-4">Tambah Kebiasaan Baru</h2><form onSubmit={addHabit} className="flex space-x-2"><input type="text" value={newHabitName} onChange={(e) => setNewHabitName(e.target.value)} placeholder="Contoh: Olahraga 15 menit" className="flex-grow p-3 border rounded-lg" required /><button type="submit" className="bg-purple-600 text-white font-bold p-3 rounded-lg hover:bg-purple-700"><PlusIcon /></button></form>{error && <p className="text-red-500 text-sm mt-2">{error}</p>}</div>
                <div><h2 className="text-lg font-semibold text-gray-800 mb-4">Tabel Kebiasaan - {selectedDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}</h2>{isLoading ? <p>Memuat...</p> : habits.length === 0 ? <div className="text-center bg-white/70 backdrop-blur-sm rounded-xl p-8"><p className="text-gray-500">Belum ada kebiasaan.</p></div> : (<div className="overflow-x-auto bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-4"><table className="w-full border-collapse text-sm text-center"><thead><tr className="bg-gray-50"><th>Kebiasaan</th>{daysArray.map(day => <th key={day} className="p-2 w-10">{day}</th>)}</tr></thead><tbody>{habits.map(h => (<tr key={h.id} className="border-b"><td className="p-2 text-left font-semibold sticky left-0 bg-white/70 backdrop-blur-sm flex items-center justify-between"><span className="truncate pr-2">{h.name}</span><button onClick={() => deleteHabit(h.id)} className="text-gray-300 hover:text-red-500"><TrashIcon /></button></td>{daysArray.map(day => { const dateString = `${monthYear}-${String(day).padStart(2, '0')}`; const isDone = (h.completions || []).includes(dateString); return (<td key={day} className="p-2 border-l"><input type="checkbox" checked={isDone} onChange={() => toggleHabitCompletion(h, day)} className="w-5 h-5 rounded text-purple-600 focus:ring-purple-500 cursor-pointer" /></td>);})}</tr>))}</tbody></table></div>)}</div>
                </>
            );
        };

        // --- Komponen Pelacak Tabungan ---
        const SavingsTracker = ({ user, ledgerId }) => {
            const [goals, setGoals] = React.useState([]);
            const [newGoalName, setNewGoalName] = React.useState('');
            const [newTargetAmount, setNewTargetAmount] = React.useState('');
            const [amountToAdd, setAmountToAdd] = React.useState({});
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');

            React.useEffect(() => {
                if (!user || !ledgerId || !db) { setIsLoading(false); setGoals([]); return; }
                setIsLoading(true);
                const collectionPath = `ledgers/${ledgerId}/savings`;
                const q = query(collection(db, collectionPath));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setGoals(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setIsLoading(false);
                }, (err) => { console.error("Firestore Error:", err); setError("Gagal memuat data tabungan."); setIsLoading(false); });
                return () => unsubscribe();
            }, [user, ledgerId]);

            const addGoal = async (e) => {
                e.preventDefault();
                if (!newGoalName || !newTargetAmount || !user || !ledgerId || !db) return;
                try {
                    const collectionPath = `ledgers/${ledgerId}/savings`;
                    await addDoc(collection(db, collectionPath), { name: newGoalName, targetAmount: Number(newTargetAmount), currentAmount: 0, createdAt: serverTimestamp(), userId: user.uid });
                    setNewGoalName(''); setNewTargetAmount(''); setError('');
                } catch (err) { console.error("Error adding goal:", err); setError("Gagal menambah target tabungan."); }
            };

            const addFunds = async (goalId) => {
                if(!db) return;
                const amount = Number(amountToAdd[goalId] || 0);
                if (amount <= 0) return;
                try { await updateDoc(doc(db, `ledgers/${ledgerId}/savings/${goalId}`), { currentAmount: increment(amount) }); setAmountToAdd(prev => ({ ...prev, [goalId]: '' })); } catch (err) { console.error("Error adding funds:", err); setError("Gagal menambah dana."); }
            };

            const deleteGoal = async (id) => {
                if(!db) return;
                try { await deleteDoc(doc(db, `ledgers/${ledgerId}/savings/${id}`)); } catch (err) { console.error("Error deleting goal:", err); setError("Gagal menghapus target."); }
            };

            return (
                <><div className="bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-6"><h2 className="text-lg font-semibold text-gray-800 mb-4">Tambah Target Tabungan Baru</h2><form onSubmit={addGoal} className="space-y-3"><input type="text" value={newGoalName} onChange={(e) => setNewGoalName(e.target.value)} placeholder="Contoh: Dana liburan" className="w-full p-3 border rounded-lg" required /><input type="number" value={newTargetAmount} onChange={(e) => setNewTargetAmount(e.target.value)} placeholder="Target (misal: 5000000)" className="w-full p-3 border rounded-lg" required /><button type="submit" className="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center"><PlusIcon /><span>Tambah Target</span></button></form>{error && <p className="text-red-500 text-sm mt-2">{error}</p>}</div>
                <div><h2 className="text-lg font-semibold text-gray-800 mb-4">Daftar Target Tabungan</h2>{isLoading ? <p>Memuat...</p> : goals.length === 0 ? <div className="text-center bg-white/70 backdrop-blur-sm rounded-xl p-8"><p className="text-gray-500">Belum ada target.</p></div> : (<div className="space-y-4">{goals.map(g => { const progress = g.targetAmount > 0 ? (g.currentAmount / g.targetAmount) * 100 : 0; return (<div key={g.id} className="bg-white/70 backdrop-blur-sm rounded-xl shadow-md p-4"><div className="flex justify-between items-start"><div><p className="font-semibold">{g.name}</p><p className="text-sm text-green-600 font-medium">{formatCurrency(g.currentAmount)} / {formatCurrency(g.targetAmount)}</p></div><button onClick={() => deleteGoal(g.id)} className="text-gray-400 hover:text-red-500 p-1 rounded-full"><TrashIcon /></button></div><div className="w-full bg-gray-200 rounded-full h-2.5 my-2"><div className="bg-green-500 h-2.5 rounded-full" style={{ width: `${progress > 100 ? 100 : progress}%` }}></div></div><div className="flex space-x-2 mt-3"><input type="number" value={amountToAdd[g.id] || ''} onChange={(e) => setAmountToAdd(prev => ({ ...prev, [g.id]: e.target.value }))} placeholder="Jumlah" className="flex-grow p-2 border rounded-lg text-sm" /><button onClick={() => addFunds(g.id)} className="bg-gray-200 font-semibold p-2 rounded-lg hover:bg-gray-300 text-sm">Tambah</button></div></div>);})}</div>)}</div>
                </>
            );
        };

        // --- Komponen ProfileSetup ---
        const ProfileSetup = ({ onProfileSubmit, user }) => {
            const [name, setName] = React.useState(user?.name || '');
            const [photo, setPhoto] = React.useState(null);
            const [photoPreview, setPhotoPreview] = React.useState(user?.photoURL || 'https://placehold.co/100x100/E2E8F0/4A5568?text=?');
            const fileInputRef = React.useRef();

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setPhoto(reader.result);
                        setPhotoPreview(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">Pengaturan Profil</h2>
                        <p className="text-gray-600 mb-6">Personalisasi akun Anda.</p>
                        <form onSubmit={(e) => { e.preventDefault(); onProfileSubmit(name, photo); }}>
                            <div className="relative w-24 h-24 mx-auto mb-4">
                                <img src={photoPreview} alt="Profile" className="w-24 h-24 rounded-full object-cover" />
                                <button type="button" onClick={() => fileInputRef.current.click()} className="absolute bottom-0 right-0 bg-blue-600 p-2 rounded-full hover:bg-blue-700">
                                    <CameraIcon />
                                </button>
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
                            </div>
                            <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="Masukkan nama Anda" className="w-full p-3 border rounded-lg mb-4" required />
                            <button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Simpan Profil</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Komponen MonthSelector ---
        const MonthSelector = ({ selectedDate, setSelectedDate }) => {
            const changeMonth = (offset) => {
                const newDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + offset, 1);
                setSelectedDate(newDate);
            };

            return (
                <div className="flex items-center justify-center bg-white/50 backdrop-blur-sm p-2 rounded-lg">
                    <button onClick={() => changeMonth(-1)} className="px-3 py-1 rounded-md hover:bg-gray-200">‹</button>
                    <span className="font-semibold w-32 text-center">{selectedDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}</span>
                    <button onClick={() => changeMonth(1)} className="px-3 py-1 rounded-md hover:bg-gray-200">›</button>
                </div>
            );
        };

        // --- Komponen Utama Aplikasi ---
        function App() {
            const [user, setUser] = React.useState(null);
            const [ledgerId, setLedgerId] = React.useState(localStorage.getItem('ledgerId') || '');
            const [tempLedgerId, setTempLedgerId] = React.useState('');
            const [copied, setCopied] = React.useState(false);
            const [activeTab, setActiveTab] = React.useState('dashboard');
            const [showProfileSetup, setShowProfileSetup] = React.useState(false);
            const [ledgerDoc, setLedgerDoc] = React.useState(null);
            const [selectedDate, setSelectedDate] = React.useState(new Date());
            const [authError, setAuthError] = React.useState(null);

            React.useEffect(() => {
                if(!authInstance) return;
                const unsubscribe = onAuthStateChanged(authInstance, async (currentUser) => {
                    if (currentUser) {
                        setUser({ uid: currentUser.uid });
                    } else {
                        try { 
                            await signInAnonymously(authInstance); 
                        } catch (err) { 
                            console.error("Authentication error:", err); 
                            setAuthError(err);
                        }
                    }
                });
                return () => unsubscribe();
            }, []);

            React.useEffect(() => {
                if (!user?.uid || !ledgerId || !db) return;
                const ledgerDocRef = doc(db, `ledgers/${ledgerId}`);
                const unsub = onSnapshot(ledgerDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setLedgerDoc(data);
                        const participants = data.participants || {};
                        if (participants[user.uid]?.name) {
                            setUser(prev => ({ ...prev, ...participants[user.uid] }));
                            setShowProfileSetup(false);
                        } else {
                            setShowProfileSetup(true);
                        }
                    } else {
                        setShowProfileSetup(true);
                    }
                });
                return unsub;
            }, [user?.uid, ledgerId]);

            const handleProfileSubmit = async (name, photoURL) => {
                if (!user || !ledgerId || !name || !db) return;
                const ledgerDocRef = doc(db, `ledgers/${ledgerId}`);
                try {
                    const currentParticipantData = ledgerDoc?.participants?.[user.uid] || {};
                    
                    const newParticipantData = {
                        name: name,
                        photoURL: photoURL || currentParticipantData.photoURL || null,
                    };

                    await setDoc(ledgerDocRef, { 
                        participants: { [user.uid]: newParticipantData } 
                    }, { merge: true });

                    setShowProfileSetup(false);
                } catch (error) { 
                    console.error("Error setting profile:", error); 
                }
            };

            const createNewLedger = () => { const newId = `BERSAMA-${Math.random().toString(36).substr(2, 6).toUpperCase()}`; setLedgerId(newId); localStorage.setItem('ledgerId', newId); };
            const joinLedger = () => { if (tempLedgerId) { setLedgerId(tempLedgerId); localStorage.setItem('ledgerId', tempLedgerId); } };
            const leaveLedger = () => { setLedgerId(''); localStorage.removeItem('ledgerId'); setActiveTab('dashboard');};
            const copyLedgerId = () => { const d = document.createElement('textarea'); d.value = ledgerId; document.body.appendChild(d); d.select(); document.execCommand('copy'); document.body.removeChild(d); setCopied(true); setTimeout(() => setCopied(false), 2000); };

            if (!isConfigValid) {
                 return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-red-50">
                        <div className="text-center p-8 bg-white rounded-lg shadow-2xl max-w-lg">
                            <h2 className="text-2xl font-bold text-red-700 mb-4">Konfigurasi Database Diperlukan</h2>
                            <p className="text-gray-700 mb-2">
                                Aplikasi ini belum terhubung ke database. Anda perlu menyalin "kunci" konfigurasi dari proyek Firebase Anda.
                            </p>
                            <p className="text-gray-700 mb-6">
                                Silakan buka file <code>index.html</code> di GitHub, cari variabel <code>firebaseConfig</code>, dan ganti isinya dengan kunci yang Anda dapatkan dari Firebase.
                            </p>
                            <a href="https://console.firebase.google.com" target="_blank" rel="noopener noreferrer" className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                                Buka Firebase Console
                            </a>
                        </div>
                    </div>
                );
            }

            if (authError) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-red-50">
                        <div className="text-center p-8 bg-white rounded-lg shadow-2xl max-w-lg">
                            <h2 className="text-2xl font-bold text-red-700 mb-4">Masalah Konfigurasi Otentikasi</h2>
                            <p className="text-gray-700 mb-2">
                                Aplikasi gagal terhubung ke layanan otentikasi Firebase.
                            </p>
                            <p className="text-gray-700 mb-2">
                                Kemungkinan besar, metode login "Anonim" belum diaktifkan di proyek Firebase Anda.
                            </p>
                             <p className="text-gray-700 mb-6">
                                Silakan buka Firebase Console, masuk ke bagian <strong>Authentication</strong>, pilih tab <strong>Sign-in method</strong>, dan aktifkan provider <strong>Anonymous</strong>.
                            </p>
                            <a href={`https://console.firebase.google.com/project/${firebaseConfig.projectId}/authentication/providers`} target="_blank" rel="noopener noreferrer" className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">
                                Buka Pengaturan Otentikasi
                            </a>
                        </div>
                    </div>
                );
            }

            if (!ledgerId) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
                        <div className="w-full max-w-md bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-8 text-center">
                            <h1 className="text-2xl font-bold mb-2">Dompet & Target Bersama</h1>
                            <p className="text-gray-600 mb-8">Atur keuangan, tabungan, dan kebiasaan bersama pasangan.</p>
                            <div className="space-y-4">
                                <button onClick={createNewLedger} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">Buat Ruang Baru</button>
                                <div className="flex items-center space-x-2">
                                    <input type="text" value={tempLedgerId} onChange={(e) => setTempLedgerId(e.target.value)} placeholder="Masukkan Kode Ruang" className="flex-grow p-3 border rounded-lg" />
                                    <button onClick={joinLedger} disabled={!tempLedgerId} className="bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 disabled:bg-gray-300">Gabung</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen font-sans bg-gradient-to-br from-blue-50 to-indigo-100">
                    {showProfileSetup && <ProfileSetup onProfileSubmit={handleProfileSubmit} user={user} />}
                    <header className="bg-white/70 backdrop-blur-sm shadow-md sticky top-0 z-20">
                        <div className="max-w-4xl mx-auto p-4">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-3">
                                    <img src={user?.photoURL || 'https://placehold.co/40x40/E2E8F0/4A5568?text=?'} alt="User" className="w-10 h-10 rounded-full object-cover" />
                                    <h1 className="text-xl font-bold text-blue-600">Ruang Bersama</h1>
                                </div>
                                <MonthSelector selectedDate={selectedDate} setSelectedDate={setSelectedDate} />
                                <button onClick={leaveLedger} className="text-sm text-red-500 hover:underline">Keluar</button>
                            </div>
                            <div className="flex justify-center items-center"><button onClick={copyLedgerId} className="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-mono py-1 px-3 rounded-full"><span>Kode: {ledgerId}</span>{copied ? <span className="text-green-500 ml-2">Tersalin!</span> : <CopyIcon />}</button></div>
                        </div>
                         <div className="border-b border-gray-200">
                            <nav className="max-w-4xl mx-auto -mb-px flex justify-around">
                                <button onClick={() => setActiveTab('dashboard')} className={`flex items-center py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'dashboard' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:border-gray-300'}`}><HomeIcon /> Dashboard</button>
                                <button onClick={() => setActiveTab('finance')} className={`flex items-center py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'finance' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:border-gray-300'}`}><MoneyIcon /> Keuangan</button>
                                <button onClick={() => setActiveTab('savings')} className={`flex items-center py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'savings' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:border-gray-300'}`}><PiggyBankIcon /> Tabungan</button>
                                <button onClick={() => setActiveTab('habits')} className={`flex items-center py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'habits' ? 'border-purple-500 text-purple-600' : 'border-transparent text-gray-500 hover:border-gray-300'}`}><TargetIcon /> Kebiasaan</button>
                            </nav>
                        </div>
                    </header>
                    <main className="max-w-4xl mx-auto p-4">
                        {activeTab === 'dashboard' && <Dashboard user={user} ledgerId={ledgerId} setActiveTab={setActiveTab} ledgerDoc={ledgerDoc} selectedDate={selectedDate} />}
                        {activeTab === 'finance' && <FinanceTracker user={user} ledgerId={ledgerId} selectedDate={selectedDate} />}
                        {activeTab === 'savings' && <SavingsTracker user={user} ledgerId={ledgerId} />}
                        {activeTab === 'habits' && <HabitTracker user={user} ledgerId={ledgerId} selectedDate={selectedDate} />}
                    </main>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
